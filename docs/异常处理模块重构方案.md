# å¼‚å¸¸å¤„ç†æ¨¡å—é‡æ„æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2025-01-15
> **å½“å‰è¯„åˆ†**: 6/10
> **ç›®æ ‡è¯„åˆ†**: 9/10

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### é‡æ„èƒŒæ™¯
é¡¹ç›®å½“å‰å¼‚å¸¸å¤„ç†æ¶æ„å­˜åœ¨**é”™è¯¯ç±»å‹ä¸ç»Ÿä¸€ã€æ—¥å¿—ç¼ºå¤±ã€ç¼ºå°‘ç›‘æ§**ç­‰é—®é¢˜ï¼Œå½±å“ç”Ÿäº§ç¯å¢ƒçš„å¯è§‚æµ‹æ€§å’Œæ•…éšœæ’æŸ¥èƒ½åŠ›ã€‚

### é‡æ„ç›®æ ‡
1. âœ… ç»Ÿä¸€é”™è¯¯ç±»å‹ä½“ç³»ï¼ˆæ¶ˆé™¤ HTTPException å’Œ AppError çš„åˆ†è£‚ï¼‰
2. âœ… å®Œå–„é”™è¯¯æ—¥å¿—å’Œ RequestId è¿½è¸ª
3. âœ… å¢å¼ºç”Ÿäº§ç¯å¢ƒå®‰å…¨æ€§ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
4. âœ… æ”¯æŒé”™è¯¯ç›‘æ§ç³»ç»Ÿé›†æˆï¼ˆé¢„ç•™æ¥å£ï¼‰
5. âœ… å¤„ç†æ•°æ®åº“é”™è¯¯ç­‰è¾¹ç•Œæƒ…å†µ

### é¢„æœŸæˆæœ
- é”™è¯¯æ—¥å¿—è®°å½•ç‡ï¼š0% â†’ 100%
- é”™è¯¯ç±»å‹ç»Ÿä¸€æ€§ï¼š60% â†’ 100%
- ç”Ÿäº§ç¯å¢ƒä¿¡æ¯æ³„éœ²é£é™©ï¼šé«˜ â†’ ä½
- é”™è¯¯è¿½è¸ªèƒ½åŠ›ï¼šæ—  â†’ å®Œæ•´ï¼ˆrequestIdï¼‰

---

## ğŸ” å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜æ¸…å•

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ |
|------|----------|----------|
| ä¸­é—´ä»¶ä½¿ç”¨ HTTPExceptionï¼ŒService ä½¿ç”¨ AppError | ğŸ”´ ä¸¥é‡ | å…¨å±€ |
| å…¨å±€é”™è¯¯å¤„ç†å™¨ç¼ºå°‘æ—¥å¿—è®°å½• | ğŸ”´ ä¸¥é‡ | ç”Ÿäº§è¿ç»´ |
| é”™è¯¯å“åº”ç¼ºå°‘ requestId | ğŸ”´ ä¸¥é‡ | é—®é¢˜è¿½è¸ª |
| æ•°æ®åº“é”™è¯¯æœªå¤„ç†ï¼Œç›´æ¥æš´éœ² | ğŸ”´ ä¸¥é‡ | å®‰å…¨æ€§ |
| ç”Ÿäº§ç¯å¢ƒå¯èƒ½æ³„éœ²å †æ ˆä¿¡æ¯ | ğŸŸ¡ ä¸­ç­‰ | å®‰å…¨æ€§ |
| ç¼ºå°‘é”™è¯¯ç›‘æ§é›†æˆ | ğŸŸ¡ ä¸­ç­‰ | å¯è§‚æµ‹æ€§ |
| é”™è¯¯ç æ— ç±»å‹å®‰å…¨ | ğŸŸ¢ æ¬¡è¦ | å¼€å‘ä½“éªŒ |

### ä¾èµ–å…³ç³»å›¾

```
src/lib/errors.ts (AppError åŸºç±»)
    â†“ è¢«å¯¼å…¥
src/lib/error-handler.ts (mapErrorToResponse)
    â†“ è¢«å¯¼å…¥
src/server/app.ts (å…¨å±€é”™è¯¯å¤„ç†å™¨)

ä½¿ç”¨æ–¹ï¼š
- src/server/middleware/jwt-auth.ts âŒ ä½¿ç”¨ HTTPException
- src/server/middleware/rbac.ts âŒ ä½¿ç”¨ HTTPException
- src/server/services/*.service.ts âœ… ä½¿ç”¨ AppError
```

---

## ğŸ¯ æ¶æ„è®¾è®¡

### 3.1 é”™è¯¯ç±»ä½“ç³»

```typescript
AppError (åŸºç±»)
â”œâ”€â”€ httpStatus: number
â”œâ”€â”€ code: string
â”œâ”€â”€ isOperational: boolean
â”œâ”€â”€ details?: unknown
â””â”€â”€ cause?: unknown

å­ç±»ï¼ˆæŒ‰ HTTP çŠ¶æ€ç åˆ†ç±»ï¼‰ï¼š
â”œâ”€â”€ 4xx å®¢æˆ·ç«¯é”™è¯¯
â”‚   â”œâ”€â”€ ValidationError (400)
â”‚   â”œâ”€â”€ UnauthorizedError (401)
â”‚   â”œâ”€â”€ ForbiddenError (403)
â”‚   â”œâ”€â”€ NotFoundError (404)
â”‚   â”œâ”€â”€ ConflictError (409)
â”‚   â””â”€â”€ BusinessError (400, è‡ªå®šä¹‰ code)
â””â”€â”€ 5xx æœåŠ¡å™¨é”™è¯¯
    â”œâ”€â”€ InternalServerError (500)
    â”œâ”€â”€ DatabaseError (500)
    â””â”€â”€ ExternalServiceError (500, æœªæ¥æ‰©å±•)
```

### 3.2 é”™è¯¯ç ä½“ç³»

```typescript
ErrorCode = {
  // å®¢æˆ·ç«¯é”™è¯¯
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  NOT_FOUND: 'NOT_FOUND',
  CONFLICT: 'CONFLICT',

  // ä¸šåŠ¡é”™è¯¯
  CANNOT_DELETE_SUPER_ADMIN: 'CANNOT_DELETE_SUPER_ADMIN',
  ...

  // æœåŠ¡å™¨é”™è¯¯
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  DATABASE_ERROR: 'DATABASE_ERROR',
}
```

### 3.3 é”™è¯¯å¤„ç†æµç¨‹

```
è¯·æ±‚ â†’ ä¸­é—´ä»¶ â†’ è·¯ç”±å¤„ç†å™¨ â†’ Service
  â†“        â†“           â†“            â†“
æŠ›å‡ºè‡ªå®šä¹‰é”™è¯¯ï¼ˆUnauthorizedError, NotFoundError ç­‰ï¼‰
  â†“
å…¨å±€é”™è¯¯å¤„ç†å™¨ (app.onError)
  â†“
mapErrorToResponse
  â”œâ”€â”€ è®°å½•é”™è¯¯æ—¥å¿— (logger.error/warn)
  â”œâ”€â”€ å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ (errorMonitor.captureError)
  â”œâ”€â”€ åŒºåˆ†ç”Ÿäº§/å¼€å‘ç¯å¢ƒ
  â””â”€â”€ è¿”å›æ ‡å‡†é”™è¯¯å“åº” { code, message, details?, requestId }
```

### 3.4 é”™è¯¯ç›‘æ§ä½“ç³»

```typescript
interface ErrorMonitor {
  captureError(error: Error, context?: Record<string, unknown>): void
  captureMessage(message: string, level: 'info' | 'warning' | 'error'): void
}

// å¯é€‰å®ç°
- ConsoleMonitor (å¼€å‘ç¯å¢ƒ)
- SentryMonitor (ç”Ÿäº§ç¯å¢ƒ)
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½ï¼ˆP0ï¼Œé¢„è®¡ 2 å°æ—¶ï¼‰

#### Step 1: åˆ›å»ºé”™è¯¯ç æšä¸¾
- **æ–‡ä»¶**: `src/lib/error-codes.ts` (æ–°å»º)
- **å†…å®¹**: ErrorCode å¸¸é‡å’Œç±»å‹å®šä¹‰
- **å˜æ›´**: æ— 
- **åŸå› **: æ‰€æœ‰é”™è¯¯ç é›†ä¸­ç®¡ç†ï¼Œæä¾›ç±»å‹å®‰å…¨

#### Step 2: å¢å¼º AppError åŸºç±»
- **æ–‡ä»¶**: `src/lib/errors.ts` (ä¿®æ”¹)
- **å˜æ›´**:
  - æ„é€ å‡½æ•°æ¥å— options å¯¹è±¡
  - æ·»åŠ  `httpStatus` å­—æ®µ
  - æ·»åŠ  `isOperational` å­—æ®µ
  - ä½¿ç”¨ `Error.captureStackTrace`
  - æ›´æ–°æ‰€æœ‰å­ç±»æ„é€ å‡½æ•°ä½¿ç”¨ ErrorCode

#### Step 3: åˆ›å»ºæ•°æ®åº“é”™è¯¯å¤„ç†å™¨
- **æ–‡ä»¶**: `src/lib/database-error-handler.ts` (æ–°å»º)
- **å†…å®¹**: `handleDatabaseError(err: unknown): AppError`
- **åŠŸèƒ½**:
  - è¯†åˆ« MySQL é”™è¯¯ç ï¼ˆER_DUP_ENTRY, ER_NO_REFERENCED_ROW_2 ç­‰ï¼‰
  - è½¬æ¢ä¸ºå¯¹åº”çš„ä¸šåŠ¡é”™è¯¯ç±»å‹
  - æ ‡è®°ç¼–ç¨‹é”™è¯¯ (isOperational=false)

#### Step 4: åˆ›å»ºé”™è¯¯ç›‘æ§æ¥å£
- **æ–‡ä»¶**: `src/lib/error-monitor.ts` (æ–°å»º)
- **å†…å®¹**:
  - `ErrorMonitor` æ¥å£å®šä¹‰
  - `setErrorMonitor/getErrorMonitor` å‡½æ•°
  - å¯é€‰çš„ `ConsoleMonitor` å®ç°

#### Step 5: å¢å¼ºé”™è¯¯æ˜ å°„å™¨
- **æ–‡ä»¶**: `src/lib/error-handler.ts` (ä¿®æ”¹)
- **å˜æ›´**:
  - `mapErrorToResponse` æ·»åŠ  `requestId?: string` å‚æ•°
  - é›†æˆ `logger` è®°å½•é”™è¯¯
  - é›†æˆ `errorMonitor` å‘é€ç›‘æ§
  - åŒºåˆ†ç”Ÿäº§/å¼€å‘ç¯å¢ƒ
  - `ErrorResponse` æ·»åŠ  `requestId` å­—æ®µ

#### Step 6: æ›´æ–°å…¨å±€é”™è¯¯å¤„ç†å™¨
- **æ–‡ä»¶**: `src/server/app.ts` (ä¿®æ”¹)
- **å˜æ›´**:
  - `onError` ä¸­è·å– `requestId`
  - ä¼ é€’ç»™ `mapErrorToResponse`
  - å“åº”ä¸­åŒ…å« `requestId`
  - å¢å¼ºæ—¥å¿—è®°å½•

#### Step 7: æ›´æ–° ErrorSchema
- **æ–‡ä»¶**: `src/server/routes/common/dtos.ts` (ä¿®æ”¹)
- **å˜æ›´**: `ErrorSchema` æ·»åŠ  `requestId` å¯é€‰å­—æ®µ

---

### é˜¶æ®µäºŒï¼šä¸­é—´ä»¶æ”¹é€ ï¼ˆP0ï¼Œé¢„è®¡ 1 å°æ—¶ï¼‰

#### Step 8: æ”¹é€  JWT è®¤è¯ä¸­é—´ä»¶
- **æ–‡ä»¶**: `src/server/middleware/jwt-auth.ts` (ä¿®æ”¹)
- **å˜æ›´**:
  - å¯¼å…¥ `UnauthorizedError`
  - `requireAuth` ä¸­ç”¨ `UnauthorizedError` æ›¿æ¢ `HTTPException`

#### Step 9: æ”¹é€  RBAC æƒé™ä¸­é—´ä»¶
- **æ–‡ä»¶**: `src/server/middleware/rbac.ts` (ä¿®æ”¹)
- **å˜æ›´**:
  - å¯¼å…¥ `UnauthorizedError`, `ForbiddenError`
  - æ‰€æœ‰æƒé™æ£€æŸ¥ä¸­é—´ä»¶æ›¿æ¢ `HTTPException`

---

### é˜¶æ®µä¸‰ï¼šæœåŠ¡å±‚ä¼˜åŒ–ï¼ˆP1ï¼Œé¢„è®¡ 30 åˆ†é’Ÿï¼‰

#### Step 10: Service å±‚æ•°æ®åº“é”™è¯¯å¤„ç†ï¼ˆç¤ºä¾‹ï¼‰
- **æ–‡ä»¶**: `src/server/services/admin.service.ts` (ä¿®æ”¹)
- **å˜æ›´**:
  - `createAdmin` ä¸­æ·»åŠ æ•°æ®åº“é”™è¯¯æ•è·
  - ä½¿ç”¨ `handleDatabaseError` è½¬æ¢
  - ä½œä¸ºæœ€ä½³å®è·µç¤ºä¾‹

---

## ğŸ“ è¯¦ç»†è®¾è®¡

### 5.1 æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | æ“ä½œ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|----------|------|--------|------|
| `src/lib/error-codes.ts` | æ–°å»º | P0 | é”™è¯¯ç æšä¸¾ |
| `src/lib/errors.ts` | ä¿®æ”¹ | P0 | å¢å¼ºé”™è¯¯åŸºç±» |
| `src/lib/database-error-handler.ts` | æ–°å»º | P0 | æ•°æ®åº“é”™è¯¯å¤„ç† |
| `src/lib/error-monitor.ts` | æ–°å»º | P0 | é”™è¯¯ç›‘æ§æ¥å£ |
| `src/lib/error-handler.ts` | ä¿®æ”¹ | P0 | å¢å¼ºé”™è¯¯æ˜ å°„å™¨ |
| `src/server/app.ts` | ä¿®æ”¹ | P0 | å…¨å±€é”™è¯¯å¤„ç†å™¨ |
| `src/server/routes/common/dtos.ts` | ä¿®æ”¹ | P0 | ErrorSchema |
| `src/server/middleware/jwt-auth.ts` | ä¿®æ”¹ | P0 | ç»Ÿä¸€é”™è¯¯ç±»å‹ |
| `src/server/middleware/rbac.ts` | ä¿®æ”¹ | P0 | ç»Ÿä¸€é”™è¯¯ç±»å‹ |
| `src/server/services/admin.service.ts` | ä¿®æ”¹ | P1 | æ•°æ®åº“é”™è¯¯å¤„ç†ç¤ºä¾‹ |

---

### 5.2 å…³é”®ä»£ç è®¾è®¡

#### 5.2.1 é”™è¯¯ç æšä¸¾ (src/lib/error-codes.ts)

```typescript
/**
 * é”™è¯¯ç å¸¸é‡
 * @description æä¾›ç±»å‹å®‰å…¨çš„é”™è¯¯ç å®šä¹‰
 */
export const ErrorCode = {
  // ========== å®¢æˆ·ç«¯é”™è¯¯ 4xx ==========
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  NOT_FOUND: 'NOT_FOUND',
  CONFLICT: 'CONFLICT',

  // ========== ä¸šåŠ¡é”™è¯¯ ==========
  BUSINESS_ERROR: 'BUSINESS_ERROR',
  CANNOT_DELETE_SUPER_ADMIN: 'CANNOT_DELETE_SUPER_ADMIN',
  CANNOT_DELETE_SELF: 'CANNOT_DELETE_SELF',
  CANNOT_MODIFY_SUPER_ADMIN_ROLES: 'CANNOT_MODIFY_SUPER_ADMIN_ROLES',

  // ========== æœåŠ¡å™¨é”™è¯¯ 5xx ==========
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  DATABASE_ERROR: 'DATABASE_ERROR',
  EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR',
} as const

export type ErrorCode = (typeof ErrorCode)[keyof typeof ErrorCode]
```

#### 5.2.2 å¢å¼ºçš„ AppError åŸºç±»

```typescript
import { ErrorCode } from './error-codes'

/**
 * åº”ç”¨é”™è¯¯åŸºç±»é€‰é¡¹
 */
export interface AppErrorOptions {
  httpStatus?: number
  details?: unknown
  cause?: unknown
  isOperational?: boolean
}

/**
 * åº”ç”¨é”™è¯¯åŸºç±»
 */
export class AppError extends Error {
  public readonly httpStatus: number
  public readonly isOperational: boolean
  public readonly details?: unknown

  constructor(
    message: string,
    public readonly code: string,
    options: AppErrorOptions = {}
  ) {
    super(message, { cause: options.cause })
    this.name = this.constructor.name
    this.httpStatus = options.httpStatus ?? 400
    this.isOperational = options.isOperational ?? true
    this.details = options.details

    // ç¡®ä¿åŸå‹é“¾æ­£ç¡®
    Object.setPrototypeOf(this, new.target.prototype)

    // æ•è·å †æ ˆä¿¡æ¯
    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, this.constructor)
    }
  }
}

// æ›´æ–°æ‰€æœ‰å­ç±»ç¤ºä¾‹
export class UnauthorizedError extends AppError {
  constructor(message = 'æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ', details?: unknown) {
    super(message, ErrorCode.UNAUTHORIZED, {
      httpStatus: 401,
      details,
      isOperational: true,
    })
  }
}

export class ForbiddenError extends AppError {
  constructor(message = 'æ— æƒé™è®¿é—®', details?: unknown) {
    super(message, ErrorCode.FORBIDDEN, {
      httpStatus: 403,
      details,
      isOperational: true,
    })
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string, id: string | number) {
    super(`${resource} with id ${id} not found`, ErrorCode.NOT_FOUND, {
      httpStatus: 404,
      isOperational: true,
    })
  }
}

export class ConflictError extends AppError {
  constructor(message: string, details?: unknown) {
    super(message, ErrorCode.CONFLICT, {
      httpStatus: 409,
      details,
      isOperational: true,
    })
  }
}

export class ValidationError extends AppError {
  constructor(message: string, details?: unknown) {
    super(message, ErrorCode.VALIDATION_ERROR, {
      httpStatus: 400,
      details,
      isOperational: true,
    })
  }
}

export class BusinessError extends AppError {
  constructor(message: string, code = ErrorCode.BUSINESS_ERROR, details?: unknown) {
    super(message, code, {
      httpStatus: 400,
      details,
      isOperational: true,
    })
  }
}

// æ–°å¢ï¼šæœåŠ¡å™¨é”™è¯¯ç±»
export class InternalServerError extends AppError {
  constructor(message = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯', cause?: unknown) {
    super(message, ErrorCode.INTERNAL_ERROR, {
      httpStatus: 500,
      cause,
      isOperational: false, // æ ‡è®°ä¸ºç¼–ç¨‹é”™è¯¯
    })
  }
}

export class DatabaseError extends AppError {
  constructor(message = 'æ•°æ®åº“æ“ä½œå¤±è´¥', cause?: unknown) {
    super(message, ErrorCode.DATABASE_ERROR, {
      httpStatus: 500,
      cause,
      isOperational: false,
    })
  }
}
```

#### 5.2.3 æ•°æ®åº“é”™è¯¯å¤„ç†å™¨

```typescript
import { ConflictError, InternalServerError, ValidationError } from './errors'

/**
 * MySQL é”™è¯¯æ¥å£
 */
interface MySQLError {
  code?: string
  errno?: number
  sqlMessage?: string
  sql?: string
}

/**
 * æ•°æ®åº“é”™è¯¯å¤„ç†å™¨
 * @description å°†æ•°æ®åº“é”™è¯¯è½¬æ¢ä¸ºå‹å¥½çš„ä¸šåŠ¡é”™è¯¯
 */
export function handleDatabaseError(err: unknown): AppError {
  // ç¡®ä¿æ˜¯å¯¹è±¡ç±»å‹
  if (!err || typeof err !== 'object') {
    return new InternalServerError('æ•°æ®åº“æ“ä½œå¤±è´¥', err)
  }

  const dbError = err as MySQLError

  // MySQL å”¯ä¸€é”®å†²çª (1062)
  if (dbError.code === 'ER_DUP_ENTRY' || dbError.errno === 1062) {
    return new ConflictError('æ•°æ®å·²å­˜åœ¨ï¼Œè¿åå”¯ä¸€æ€§çº¦æŸ')
  }

  // MySQL å¤–é”®çº¦æŸå¤±è´¥ - å¼•ç”¨ä¸å­˜åœ¨ (1452)
  if (dbError.code === 'ER_NO_REFERENCED_ROW_2' || dbError.errno === 1452) {
    return new ValidationError('å…³è”çš„æ•°æ®ä¸å­˜åœ¨')
  }

  // MySQL å¤–é”®çº¦æŸå¤±è´¥ - è¢«å¼•ç”¨æ— æ³•åˆ é™¤ (1451)
  if (dbError.code === 'ER_ROW_IS_REFERENCED_2' || dbError.errno === 1451) {
    return new ConflictError('æ•°æ®æ­£åœ¨è¢«ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤')
  }

  // è¿æ¥é”™è¯¯
  if (dbError.code === 'ECONNREFUSED') {
    return new InternalServerError('æ•°æ®åº“è¿æ¥å¤±è´¥', err)
  }

  // è¶…æ—¶é”™è¯¯
  if (dbError.code === 'ETIMEDOUT') {
    return new InternalServerError('æ•°æ®åº“è¿æ¥è¶…æ—¶', err)
  }

  // ç¼–ç¨‹é”™è¯¯ï¼ˆå­—æ®µä¸å­˜åœ¨ã€SQLè¯­æ³•é”™è¯¯ç­‰ï¼‰
  if (
    dbError.code === 'ER_BAD_FIELD_ERROR' ||
    dbError.code === 'ER_PARSE_ERROR' ||
    dbError.errno === 1054 ||
    dbError.errno === 1064
  ) {
    return new InternalServerError('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯', err)
  }

  // å…¶ä»–æœªçŸ¥æ•°æ®åº“é”™è¯¯
  return new InternalServerError('æ•°æ®åº“æ“ä½œå¤±è´¥', err)
}
```

#### 5.2.4 é”™è¯¯ç›‘æ§æ¥å£

```typescript
/**
 * é”™è¯¯ç›‘æ§æ¥å£
 * @description æ”¯æŒ Sentryã€DataDog ç­‰ç¬¬ä¸‰æ–¹ç›‘æ§ç³»ç»Ÿé›†æˆ
 */
export interface ErrorMonitor {
  /**
   * æ•è·é”™è¯¯
   */
  captureError(error: Error, context?: Record<string, unknown>): void

  /**
   * æ•è·æ¶ˆæ¯
   */
  captureMessage(message: string, level: 'info' | 'warning' | 'error'): void
}

/**
 * æ§åˆ¶å°ç›‘æ§å®ç°ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
 */
export class ConsoleMonitor implements ErrorMonitor {
  captureError(error: Error, context?: Record<string, unknown>): void {
    console.error('[ErrorMonitor]', error, context)
  }

  captureMessage(message: string, level: 'info' | 'warning' | 'error'): void {
    console[level]('[ErrorMonitor]', message)
  }
}

let errorMonitor: ErrorMonitor | null = null

/**
 * è®¾ç½®é”™è¯¯ç›‘æ§å®ä¾‹
 */
export function setErrorMonitor(monitor: ErrorMonitor): void {
  errorMonitor = monitor
}

/**
 * è·å–é”™è¯¯ç›‘æ§å®ä¾‹
 */
export function getErrorMonitor(): ErrorMonitor | null {
  return errorMonitor
}
```

#### 5.2.5 å¢å¼ºçš„é”™è¯¯æ˜ å°„å™¨

```typescript
import { env } from '@/env'
import { logger } from '@/lib/logger'
import { AppError } from './errors'
import { getErrorMonitor } from './error-monitor'

export interface ErrorResponse {
  status: number
  code: string
  message: string
  details?: unknown
  requestId?: string
}

/**
 * å¢å¼ºçš„é”™è¯¯æ˜ å°„å™¨
 * @description é›†æˆæ—¥å¿—ã€ç›‘æ§ã€ç¯å¢ƒä¿æŠ¤
 */
export function mapErrorToResponse(
  err: unknown,
  requestId?: string
): ErrorResponse {
  const logMeta = { requestId, error: err }

  // å¤„ç†è‡ªå®šä¹‰åº”ç”¨é”™è¯¯
  if (err instanceof AppError) {
    // è®°å½•é”™è¯¯æ—¥å¿—
    if (!err.isOperational) {
      // ç¼–ç¨‹é”™è¯¯ï¼šè®°å½•å®Œæ•´å †æ ˆ
      logger.error(err.message, {
        ...logMeta,
        code: err.code,
        httpStatus: err.httpStatus,
        stack: err.stack,
        cause: err.cause,
      })
    } else {
      // æ“ä½œæ€§é”™è¯¯ï¼šè®°å½•ä¸ºè­¦å‘Š
      logger.warn(err.message, {
        ...logMeta,
        code: err.code,
        httpStatus: err.httpStatus,
      })
    }

    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    const monitor = getErrorMonitor()
    if (monitor && !err.isOperational) {
      monitor.captureError(err, { requestId, code: err.code })
    }

    return {
      status: err.httpStatus,
      code: err.code,
      message: err.message,
      details: env.NODE_ENV === 'production' ? undefined : err.details,
      requestId,
    }
  }

  // å¤„ç†æœªçŸ¥é”™è¯¯
  logger.error('Unhandled error', {
    ...logMeta,
    stack: err instanceof Error ? err.stack : undefined,
  })

  // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  const monitor = getErrorMonitor()
  if (monitor && err instanceof Error) {
    monitor.captureError(err, { requestId })
  }

  // ç”Ÿäº§ç¯å¢ƒéšè—è¯¦æƒ…
  const message =
    env.NODE_ENV === 'production'
      ? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
      : err instanceof Error
        ? err.message
        : 'Internal Server Error'

  return {
    status: 500,
    code: 'INTERNAL_ERROR',
    message,
    requestId,
  }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•ï¼ˆå¯é€‰ï¼‰

**é”™è¯¯ç±»æµ‹è¯•**ï¼š
- éªŒè¯æ¯ä¸ªé”™è¯¯ç±»çš„å®ä¾‹åŒ–
- éªŒè¯ `httpStatus` æ­£ç¡®
- éªŒè¯ `isOperational` æ ‡è®°
- éªŒè¯ `cause` ä¼ é€’

**æ•°æ®åº“é”™è¯¯å¤„ç†å™¨æµ‹è¯•**ï¼š
- æ¨¡æ‹Ÿå„ç§ MySQL é”™è¯¯ç 
- éªŒè¯è½¬æ¢ä¸ºæ­£ç¡®çš„é”™è¯¯ç±»å‹

**é”™è¯¯æ˜ å°„å™¨æµ‹è¯•**ï¼š
- æµ‹è¯•å„ç§é”™è¯¯ç±»å‹çš„æ˜ å°„
- éªŒè¯æ—¥å¿—è°ƒç”¨
- éªŒè¯ç¯å¢ƒåŒºåˆ†ï¼ˆmock NODE_ENVï¼‰

### 6.2 é›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰

**ä¸­é—´ä»¶æµ‹è¯•**ï¼š
- æµ‹è¯•æœªç™»å½•è¿”å› 401
- æµ‹è¯•æ— æƒé™è¿”å› 403
- éªŒè¯é”™è¯¯å“åº”æ ¼å¼åŒ…å« requestId

**API ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
- æµ‹è¯•å„ç§é”™è¯¯åœºæ™¯
- éªŒè¯é”™è¯¯å“åº”ç¬¦åˆ OpenAPI schema

---

## âš ï¸ é£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ

### 7.1 é£é™©ç­‰çº§

| å˜æ›´ç±»å‹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|----------|----------|----------|----------|
| æ–°å¢æ–‡ä»¶ | ğŸŸ¢ ä½ | æ— å½±å“ | ç›´æ¥åˆ é™¤å³å¯å›æ»š |
| å¢å¼ºé”™è¯¯ç±» | ğŸŸ¡ ä¸­ | Service å±‚ | å‘åå…¼å®¹ï¼Œä¿æŒç°æœ‰å‚æ•°åˆ—è¡¨ |
| ä¿®æ”¹é”™è¯¯æ˜ å°„å™¨ | ğŸŸ¡ ä¸­ | å…¨å±€é”™è¯¯å¤„ç† | requestId å‚æ•°è®¾ä¸ºå¯é€‰ |
| æ”¹é€ ä¸­é—´ä»¶ | ğŸŸ  é«˜ | æ‰€æœ‰å—ä¿æŠ¤è·¯ç”± | åˆ†é˜¶æ®µæäº¤ï¼Œä¿ç•™ HTTPException å¤„ç† |

### 7.2 å›æ»šç­–ç•¥

**Git æäº¤ç­–ç•¥**ï¼š
1. æ¯ä¸ªé˜¶æ®µç‹¬ç«‹æäº¤
2. æäº¤ä¿¡æ¯æ¸…æ™°æè¿°å˜æ›´
3. æ¯æ¬¡æäº¤åç¡®ä¿é¡¹ç›®å¯è¿è¡Œ

**å›æ»šæ­¥éª¤**ï¼š
```bash
# æŸ¥çœ‹æäº¤å†å²
git log --oneline

# å›æ»šåˆ°æŒ‡å®šæäº¤
git reset --hard <commit-hash>

# æˆ–è€…åˆ›å»ºå›æ»šæäº¤
git revert <commit-hash>
```

### 7.3 å®æ–½å‰æ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆå¦‚æœ‰ï¼‰
- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] åœ¨å¼€å‘ç¯å¢ƒéªŒè¯åŸºæœ¬æµç¨‹
- [ ] Code Review å®Œæˆ
- [ ] å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰

---

## âœ… éªŒæ”¶æ ‡å‡†

### 8.1 åŠŸèƒ½æ€§éªŒæ”¶

- [ ] æ‰€æœ‰é”™è¯¯ç±»å‹ç»Ÿä¸€ä½¿ç”¨ `AppError` ä½“ç³»
- [ ] é”™è¯¯å“åº”åŒ…å« `requestId`
- [ ] ç”Ÿäº§ç¯å¢ƒä¸æš´éœ²å †æ ˆä¿¡æ¯å’Œæ•æ„Ÿè¯¦æƒ…
- [ ] æ•°æ®åº“å”¯ä¸€é”®å†²çªè¿”å› 409 è€Œé 500
- [ ] æœªç™»å½•è¿”å› 401ï¼Œæ— æƒé™è¿”å› 403

### 8.2 éåŠŸèƒ½æ€§éªŒæ”¶

- [ ] é”™è¯¯æ—¥å¿—æ­£å¸¸è®°å½•åˆ° logger
- [ ] é”™è¯¯æ—¥å¿—åŒ…å« requestId å’Œé”™è¯¯ä¸Šä¸‹æ–‡
- [ ] 500 é”™è¯¯åŒ…å«å®Œæ•´å †æ ˆä¿¡æ¯ï¼ˆä»…æ—¥å¿—ï¼‰
- [ ] TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] æ—  ESLint/Biome é”™è¯¯

### 8.3 API å¥‘çº¦éªŒæ”¶

- [ ] é”™è¯¯å“åº”æ ¼å¼ç¬¦åˆ OpenAPI schema
- [ ] HTTP çŠ¶æ€ç æ­£ç¡®æ˜ å°„
- [ ] é”™è¯¯ç è¯­ä¹‰æ¸…æ™°

---

## ğŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæœ

### è¯„åˆ†æå‡

| ç»´åº¦ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| é”™è¯¯ç±»å‹è®¾è®¡ | 2.0 | 2.0 | - |
| é”™è¯¯æ˜ å°„æœºåˆ¶ | 1.5 | 2.0 | âœ… +0.5 |
| é”™è¯¯æ—¥å¿— | 0.5 | 2.0 | âœ… +1.5 |
| é”™è¯¯ä¸Šä¸‹æ–‡ | 0.5 | 1.0 | âœ… +0.5 |
| ç»Ÿä¸€æ€§ | 0.0 | 1.0 | âœ… +1.0 |
| å¯ç»´æŠ¤æ€§ | 1.0 | 1.0 | - |
| ç”Ÿäº§å°±ç»ªåº¦ | 0.5 | 1.0 | âœ… +0.5 |
| **æ€»åˆ†** | **6/10** | **9/10** | **+3** |

### å…³é”®æŒ‡æ ‡

- é”™è¯¯æ—¥å¿—è®°å½•ç‡ï¼š**0% â†’ 100%**
- é”™è¯¯ç±»å‹ç»Ÿä¸€æ€§ï¼š**60% â†’ 100%**
- RequestId è¿½è¸ªè¦†ç›–ç‡ï¼š**0% â†’ 100%**
- ç”Ÿäº§ç¯å¢ƒä¿¡æ¯æ³„éœ²é£é™©ï¼š**é«˜ â†’ ä½**

---

## ğŸ“š é™„å½•

### A. é”™è¯¯ç å®Œæ•´åˆ—è¡¨

```typescript
export const ErrorCode = {
  // å®¢æˆ·ç«¯é”™è¯¯
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  NOT_FOUND: 'NOT_FOUND',
  CONFLICT: 'CONFLICT',

  // ä¸šåŠ¡é”™è¯¯
  BUSINESS_ERROR: 'BUSINESS_ERROR',
  CANNOT_DELETE_SUPER_ADMIN: 'CANNOT_DELETE_SUPER_ADMIN',
  CANNOT_DELETE_SELF: 'CANNOT_DELETE_SELF',
  CANNOT_MODIFY_SUPER_ADMIN_ROLES: 'CANNOT_MODIFY_SUPER_ADMIN_ROLES',

  // æœåŠ¡å™¨é”™è¯¯
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  DATABASE_ERROR: 'DATABASE_ERROR',
  EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR',
}
```

### B. MySQL é”™è¯¯ç æ˜ å°„è¡¨

| MySQL é”™è¯¯ç  | errno | è½¬æ¢ä¸º | HTTP çŠ¶æ€ |
|-------------|-------|--------|-----------|
| ER_DUP_ENTRY | 1062 | ConflictError | 409 |
| ER_NO_REFERENCED_ROW_2 | 1452 | ValidationError | 400 |
| ER_ROW_IS_REFERENCED_2 | 1451 | ConflictError | 409 |
| ER_BAD_FIELD_ERROR | 1054 | InternalServerError | 500 |
| ER_PARSE_ERROR | 1064 | InternalServerError | 500 |
| ECONNREFUSED | - | InternalServerError | 500 |
| ETIMEDOUT | - | InternalServerError | 500 |

### C. é”™è¯¯ç›‘æ§ç³»ç»Ÿé›†æˆç¤ºä¾‹ï¼ˆSentryï¼‰

```typescript
import * as Sentry from '@sentry/node'
import type { ErrorMonitor } from '@/lib/error-monitor'

export class SentryMonitor implements ErrorMonitor {
  captureError(error: Error, context?: Record<string, unknown>): void {
    Sentry.captureException(error, { extra: context })
  }

  captureMessage(message: string, level: 'info' | 'warning' | 'error'): void {
    Sentry.captureMessage(message, level)
  }
}

// åˆå§‹åŒ–ï¼ˆåœ¨ instrumentation.ts ä¸­ï¼‰
if (env.NODE_ENV === 'production') {
  Sentry.init({ dsn: env.SENTRY_DSN })
  setErrorMonitor(new SentryMonitor())
}
```

---

## ğŸ‰ æ€»ç»“

æœ¬é‡æ„æ–¹æ¡ˆé€šè¿‡ç»Ÿä¸€é”™è¯¯ç±»å‹ä½“ç³»ã€å®Œå–„æ—¥å¿—ç›‘æ§ã€å¢å¼ºç”Ÿäº§ç¯å¢ƒå®‰å…¨æ€§ï¼Œå°†å¼‚å¸¸å¤„ç†æ¨¡å—ä»**6åˆ†æå‡åˆ°9åˆ†**ã€‚

**æ ¸å¿ƒæ”¹è¿›**ï¼š
1. âœ… æ¶ˆé™¤ HTTPException å’Œ AppError çš„åˆ†è£‚
2. âœ… å®Œæ•´çš„é”™è¯¯æ—¥å¿—å’Œ RequestId è¿½è¸ª
3. âœ… æ•°æ®åº“é”™è¯¯å‹å¥½è½¬æ¢
4. âœ… ç”Ÿäº§ç¯å¢ƒä¿¡æ¯ä¿æŠ¤
5. âœ… é¢„ç•™é”™è¯¯ç›‘æ§é›†æˆ

**å®æ–½å»ºè®®**ï¼š
- ä¼˜å…ˆå®Œæˆ P0 é˜¶æ®µï¼ˆåŸºç¡€è®¾æ–½ + ä¸­é—´ä»¶æ”¹é€ ï¼‰
- P1 é˜¶æ®µï¼ˆService å±‚ä¼˜åŒ–ï¼‰å¯æ¸è¿›å¼æ¨è¿›
- æ¯ä¸ªé˜¶æ®µç‹¬ç«‹æäº¤ï¼Œç¡®ä¿å¯å›æ»š

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-01-15
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
