# å…¨æ ˆæ¶æ„è§„èŒƒ v2.0 - Next.js + Hono RPC

---

## ğŸ“– ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#1-å¿«é€Ÿå¼€å§‹)
2. [æŠ€æœ¯æ ˆ](#2-æŠ€æœ¯æ ˆ)
3. [æ ¸å¿ƒæ¶æ„](#3-æ ¸å¿ƒæ¶æ„)
4. [é¡¹ç›®ç»“æ„](#4-é¡¹ç›®ç»“æ„)
5. [ç¯å¢ƒé…ç½®](#5-ç¯å¢ƒé…ç½®)
6. [æ•°æ®åº“é…ç½®](#6-æ•°æ®åº“é…ç½®)
7. [è®¤è¯ä¸é‰´æƒ](#7-è®¤è¯ä¸é‰´æƒ)
8. [åˆ†å±‚è®¾è®¡](#8-åˆ†å±‚è®¾è®¡)
9. [å®¢æˆ·ç«¯é›†æˆ](#9-å®¢æˆ·ç«¯é›†æˆ)
10. [å®‰å…¨è§„èŒƒ](#10-å®‰å…¨è§„èŒƒ)
11. [é”™è¯¯å¤„ç†](#11-é”™è¯¯å¤„ç†)
12. [æ€§èƒ½ä¼˜åŒ–](#12-æ€§èƒ½ä¼˜åŒ–)
13. [å¼€å‘å·¥ä½œæµ](#13-å¼€å‘å·¥ä½œæµ)
14. [æœ€ä½³å®è·µ](#14-æœ€ä½³å®è·µ)
15. [æ ¸å¿ƒå·¥å…·å®ç°å‚è€ƒ](#15-æ ¸å¿ƒå·¥å…·å®ç°å‚è€ƒ)

---
clear

## 1. å¿«é€Ÿå¼€å§‹

### 1.1 åˆå§‹åŒ–é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®
pnpm create next-app@latest my-app --typescript --tailwind --app

cd my-app

# å®‰è£…æ ¸å¿ƒä¾èµ–
pnpm add hono @hono/zod-openapi @hono/swagger-ui
pnpm add drizzle-orm drizzle-zod postgres
pnpm add next-auth @auth/drizzle-adapter
pnpm add @tanstack/react-query zustand
pnpm add zod @t3-oss/env-nextjs
pnpm add hono-rate-limiter

# å¼€å‘ä¾èµ–
pnpm add -D drizzle-kit @biomejs/biome
```

### 1.2 åˆ›å»ºæ ¸å¿ƒæ–‡ä»¶

å‚è§ [ç¬¬ 4 èŠ‚ï¼šé¡¹ç›®ç»“æ„](#4-é¡¹ç›®ç»“æ„) äº†è§£å®Œæ•´ç›®å½•ç»“æ„ã€‚

### 1.3 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```

---

## 2. æŠ€æœ¯æ ˆ

> ğŸ“Œ æ‰€æœ‰ä¾èµ–å‡ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼Œå®‰è£…æ—¶æ— éœ€æŒ‡å®šç‰ˆæœ¬å·ã€‚

### 2.1 æ ¸å¿ƒæ¡†æ¶

| æŠ€æœ¯ | ä½œç”¨ | é€‰å‹ç†ç”± |
|------|------|----------|
| **Next.js** | React å…¨æ ˆæ¡†æ¶ | App Router æ¶æ„ï¼Œæ”¯æŒ RSC/SSR/SSGï¼Œå†…ç½®è·¯ç”±ã€API Routesã€ä¸­é—´ä»¶ï¼ŒVercel åŸç”Ÿæ”¯æŒ |
| **Hono** | è½»é‡çº§ Web æ¡†æ¶ | è¶…è½»é‡ï¼ˆ~14KBï¼‰ï¼Œå†…ç½® RPC Client å®ç°ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ï¼ŒåŸç”Ÿ OpenAPI æ”¯æŒï¼ŒEdge Runtime å…¼å®¹ |
| **Auth.js** | è®¤è¯è§£å†³æ–¹æ¡ˆ | æ”¯æŒ OAuth/Credentials/Magic Link ç­‰å¤šç§è®¤è¯æ–¹å¼ï¼Œä¸ Next.js æ·±åº¦é›†æˆï¼ŒJWT/Database Session å¯é€‰ |
| **Drizzle ORM** | ç±»å‹å®‰å…¨ SQL ORM | é›¶è¿è¡Œæ—¶å¼€é”€ï¼ŒSQL-like è¯­æ³•ï¼Œå®Œæ•´ TypeScript æ¨å¯¼ï¼Œæ”¯æŒ Schema è¿ç§»ä¸ Studio å¯è§†åŒ– |
| **PostgreSQL** | å…³ç³»å‹æ•°æ®åº“ | ACID äº‹åŠ¡æ”¯æŒï¼ŒJSON/JSONB åŸç”Ÿæ”¯æŒï¼Œä¸°å¯Œçš„æ‰©å±•ç”Ÿæ€ï¼ˆPostGISã€pg_vector ç­‰ï¼‰ |

### 2.2 çŠ¶æ€ç®¡ç†

| æŠ€æœ¯ | ä½œç”¨ | é€‰å‹ç†ç”± |
|------|------|----------|
| **TanStack Query** | æœåŠ¡ç«¯çŠ¶æ€ç®¡ç† | è‡ªåŠ¨ç¼“å­˜/é‡è¯•/å¤±æ•ˆï¼Œæ”¯æŒä¹è§‚æ›´æ–°ï¼Œå†…ç½® DevToolsï¼ŒSSR Hydration æ”¯æŒ |
| **Zustand** | å®¢æˆ·ç«¯ UI çŠ¶æ€ | æç®€ APIï¼ˆæ—  Providerï¼‰ï¼Œæ”¯æŒä¸­é—´ä»¶ï¼ˆpersist/devtoolsï¼‰ï¼Œä½“ç§¯å°ï¼ˆ~1KBï¼‰ |

### 2.3 æ•°æ®æ ¡éªŒä¸ç±»å‹

| æŠ€æœ¯ | ä½œç”¨ | é€‰å‹ç†ç”± |
|------|------|----------|
| **TypeScript** | é™æ€ç±»å‹ç³»ç»Ÿ | ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼ŒIDE æ™ºèƒ½æç¤ºï¼Œé‡æ„å®‰å…¨æ€§ä¿éšœ |
| **Zod** | è¿è¡Œæ—¶ Schema æ ¡éªŒ | TypeScript-first è®¾è®¡ï¼Œæ”¯æŒ `.transform()/.refine()`ï¼Œä¸ Hono OpenAPI æ·±åº¦é›†æˆ |
| **@t3-oss/env-nextjs** | ç¯å¢ƒå˜é‡æ ¡éªŒ | æ„å»ºæ—¶éªŒè¯ç¯å¢ƒå˜é‡ï¼ŒåŒºåˆ† server/client å˜é‡ï¼Œå®Œæ•´ç±»å‹æ¨å¯¼ |

### 2.4 å¼€å‘å·¥å…·é“¾

| æŠ€æœ¯ | ä½œç”¨ | é€‰å‹ç†ç”± |
|------|------|----------|
| **pnpm** | åŒ…ç®¡ç†å™¨ | ç¡¬é“¾æ¥èŠ‚çœç£ç›˜ç©ºé—´ï¼Œä¸¥æ ¼ä¾èµ–éš”ç¦»ï¼ŒMonorepo åŸç”Ÿæ”¯æŒ |
| **Biome** | Linter + Formatter | Rust å®ç°ï¼ˆæ¯” ESLint å¿« 10-100xï¼‰ï¼Œé›¶é…ç½®å¼€ç®±å³ç”¨ï¼Œç»Ÿä¸€ lint/format |
| **Drizzle Kit** | æ•°æ®åº“è¿ç§»å·¥å…· | è‡ªåŠ¨ç”Ÿæˆè¿ç§» SQLï¼Œæ”¯æŒ push/pull/studioï¼Œä¸ Drizzle ORM æ— ç¼é›†æˆ |

### 2.5 UI å±‚

| æŠ€æœ¯ | ä½œç”¨ | é€‰å‹ç†ç”± |
|------|------|----------|
| **Tailwind CSS** | åŸå­åŒ– CSS æ¡†æ¶ | é›¶è¿è¡Œæ—¶ï¼ŒJIT ç¼–è¯‘æŒ‰éœ€ç”Ÿæˆï¼Œè®¾è®¡ç³»ç»Ÿçº¦æŸï¼Œä¸ RSC å®Œç¾å…¼å®¹ |
| **shadcn/ui** | ç»„ä»¶åº“ | é npm ä¾èµ–ï¼ˆä»£ç å¤åˆ¶ï¼‰ï¼ŒåŸºäº Radix UI æ— éšœç¢æ”¯æŒï¼Œå®Œå…¨å¯å®šåˆ¶ |
| **Lucide** | å›¾æ ‡åº“ | Tree-shakable SVG å›¾æ ‡ï¼Œä¸ shadcn/ui é£æ ¼ç»Ÿä¸€ï¼Œæ”¯æŒæŒ‰éœ€å¯¼å…¥ |

### 2.6 å®‰å…¨ä¸ä¸­é—´ä»¶

| æŠ€æœ¯ | ä½œç”¨ | é€‰å‹ç†ç”± |
|------|------|----------|
| **hono-rate-limiter** | API é€Ÿç‡é™åˆ¶ | é˜²æ­¢æš´åŠ›ç ´è§£/DDoSï¼Œæ”¯æŒæ»‘åŠ¨çª—å£ç®—æ³•ï¼Œå¯é…ç½®å­˜å‚¨åç«¯ |
| **@hono/swagger-ui** | API æ–‡æ¡£ UI | è‡ªåŠ¨ä» OpenAPI Schema ç”Ÿæˆäº¤äº’å¼æ–‡æ¡£ï¼Œæ”¯æŒåœ¨çº¿è°ƒè¯• |

---

## 3. æ ¸å¿ƒæ¶æ„

### 3.1 åˆ†å±‚æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Presentation Layer                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Server Componentâ”‚   â”‚ Client Component  â”‚   â”‚
â”‚  â”‚   (RSC/Page)    â”‚   â”‚  (Interactive UI) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚
            â”‚ Direct Import        â”‚ HTTP (RPC)
            â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           â–¼                      â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          API Layer (Hono Routes)         â”‚  â”‚
â”‚  â”‚  - å‚æ•°æ ¡éªŒ (Zod)                         â”‚  â”‚
â”‚  â”‚  - æƒé™æ£€æŸ¥ (Middleware)                  â”‚  â”‚
â”‚  â”‚  - é”™è¯¯è½¬æ¢ (Service â†’ HTTP)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Business Logic Layer                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Service Layer (*.service.ts)      â”‚  â”‚
â”‚  â”‚  - çº¯ä¸šåŠ¡é€»è¾‘                             â”‚  â”‚
â”‚  â”‚  - äº‹åŠ¡å¤„ç†                               â”‚  â”‚
â”‚  â”‚  - å¤æ‚æŸ¥è¯¢                               â”‚  â”‚
â”‚  â”‚  - æ—  HTTP ä¸Šä¸‹æ–‡                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Data Access Layer                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      Drizzle ORM + PostgreSQL            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµè§„åˆ™

| è°ƒç”¨æ–¹ | ç›®æ ‡ | æ–¹å¼ | ç¦æ­¢ |
|--------|------|------|------|
| RSC | Service å±‚ | ç›´æ¥å¯¼å…¥ | âŒ HTTP è°ƒç”¨è‡ªèº« API |
| Client | API å±‚ | Hono RPC | âŒ å¯¼å…¥ Service å±‚ |
| API å±‚ | Service å±‚ | å‡½æ•°è°ƒç”¨ | âŒ ç›´æ¥å†™ SQL |
| Service å±‚ | æ•°æ®åº“ | Drizzle ORM | âŒ åŒ…å« HTTP é€»è¾‘ |

### 3.3 Next.js 15 å¼‚æ­¥è¯·æ±‚ä¸Šä¸‹æ–‡

- åœ¨ Page/Layout/Route Handler ä¸­è®¿é—® `params`ã€`searchParams`ã€`cookies()`ã€`headers()` æ—¶ï¼Œéœ€è¦é€šè¿‡ `await` è·å–ï¼š

```typescript
export default async function Page(props: {
  params: Promise<{ id: string }>
  searchParams: Promise<{ q?: string }>
}) {
  const params = await props.params
  const searchParams = await props.searchParams

  // ...
}
```

- `cookies()` ä¸ `headers()` ä¹Ÿè¿”å› Promiseï¼š

```typescript
import { cookies, headers } from 'next/headers'

export default async function Page() {
  const cookieStore = await cookies()
  const headerStore = await headers()

  const locale = headerStore.get('accept-language')
  // ...
}
```

---

## 4. é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡æ¨¡æ¿ ğŸ“„
â”œâ”€â”€ middleware.ts               # Next.js Middleware (è·¯ç”±å®ˆå«) ğŸ›¡ï¸
â”œâ”€â”€ drizzle.config.ts           # Drizzle Kit é…ç½® âš™ï¸
â”œâ”€â”€ biome.json                  # Biome ä»£ç è§„èŒƒé…ç½®
â”œâ”€â”€ tsconfig.json               # TypeScript é…ç½® (å«è·¯å¾„åˆ«å) âš™ï¸
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ env.mjs                 # ç¯å¢ƒå˜é‡æ ¡éªŒ (æ ¹ç›®å½•) âš¡
â”‚   â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ [[...route]]/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts    # Hono å…¥å£ ğŸš€
â”‚   â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚   â”‚       â””â”€â”€ [...nextauth]/
â”‚   â”‚   â”‚           â””â”€â”€ route.ts # Auth.js å…¥å£ ğŸ”‘
â”‚   â”‚   â”œâ”€â”€ providers.tsx       # React Query / Auth Providers
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ db/                     # æ•°æ®åº“æ¨¡å— ğŸ—„ï¸
â”‚   â”‚   â”œâ”€â”€ schema.ts           # Drizzle Schema å®šä¹‰ (å« Auth.js æ‰€éœ€è¡¨)
â”‚   â”‚   â””â”€â”€ index.ts            # æ•°æ®åº“è¿æ¥å®ä¾‹ (å•ä¾‹)
â”‚   â”œâ”€â”€ types/                  # ç±»å‹å£°æ˜æ‰©å±•
â”‚   â”‚   â””â”€â”€ next-auth.d.ts      # Auth.js ç±»å‹æ‰©å±•
â”‚   â”œâ”€â”€ hooks/                  # è‡ªå®šä¹‰ React Hooks ğŸª
â”‚   â”‚   â”œâ”€â”€ use-users-query.ts  # ç”¨æˆ·æŸ¥è¯¢ Hook
â”‚   â”‚   â””â”€â”€ use-auth.ts         # è®¤è¯çŠ¶æ€ Hook
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ auth.ts             # Auth.js æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ client.ts           # Hono RPC Client
â”‚   â”‚   â”œâ”€â”€ logger.ts           # ç»“æ„åŒ–æ—¥å¿—å·¥å…·
â”‚   â”‚   â”œâ”€â”€ errors.ts           # è‡ªå®šä¹‰é”™è¯¯ç±»
â”‚   â”‚   â”œâ”€â”€ error-handler.ts    # é”™è¯¯æ˜ å°„å·¥å…·
â”‚   â”‚   â”œâ”€â”€ request-context.ts  # AsyncLocalStorage å®ç°
â”‚   â”œâ”€â”€ utils/                  # é€šç”¨å·¥å…·å‡½æ•° ğŸ”§
â”‚   â”‚   â””â”€â”€ format.ts           # æ ¼å¼åŒ–å·¥å…·
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â”œâ”€â”€ app.ts              # Hono å®ä¾‹ + å…¨å±€é”™è¯¯å¤„ç†
â”‚   â”‚   â”œâ”€â”€ route-defs.ts       # è·¯ç”±æ‹¼è£…ä¸ç±»å‹å¯¼å‡º ğŸ”—
â”‚   â”‚   â”œâ”€â”€ context.ts          # å…±äº«ç±»å‹å®šä¹‰ (Context/Variables) ğŸ”Œ
â”‚   â”‚   â”œâ”€â”€ types.ts            # ä»…ç±»å‹å¯¼å‡ºï¼ˆé›¶å‰¯ä½œç”¨ï¼‰âœ¨
â”‚   â”‚   â”œâ”€â”€ middleware/         # Hono ä¸­é—´ä»¶ (Auth/Logger/CORS)
â”‚   â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘å±‚ (çº¯å‡½æ•°/ç±»)
â”‚   â”‚   â””â”€â”€ routes/             # Feature-based è·¯ç”±ç»„ ğŸ“‚
â”‚   â”‚       â”œâ”€â”€ users/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.ts        # è·¯ç”±å…¥å£
â”‚   â”‚       â”‚   â”œâ”€â”€ defs.ts         # OpenAPI å¥‘çº¦å®šä¹‰
â”‚   â”‚       â”‚   â””â”€â”€ dtos.ts         # æ•°æ®è½¬æ¢ä¸ Schema
â”‚   â”‚       â””â”€â”€ posts/
â”‚   â””â”€â”€ components/             # å¤ç”¨ç»„ä»¶
â”œâ”€â”€ drizzle/                    # è¿ç§»æ–‡ä»¶è¾“å‡ºç›®å½• (Generated)
â””â”€â”€ public/
```

### 4.1 è·¯å¾„åˆ«åé…ç½® (`tsconfig.json`)

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts", "src/env.mjs"],
  "exclude": ["node_modules"]
}
```

---

## 5. ç¯å¢ƒé…ç½®

### 5.1 å®šä¹‰ç¯å¢ƒå˜é‡ (`src/env.mjs`)

```javascript
import { createEnv } from '@t3-oss/env-nextjs'
import { z } from 'zod'

export const env = createEnv({
  /**
   * æœåŠ¡ç«¯ç¯å¢ƒå˜é‡
   */
  server: {
    DATABASE_URL: z.string().url(),
    DATABASE_MAX_CONNECTIONS: z.coerce.number().int().positive().optional(),
    DATABASE_IDLE_TIMEOUT: z.coerce.number().int().positive().optional(),
    DATABASE_CONNECT_TIMEOUT: z.coerce.number().int().positive().optional(),
    AUTH_SECRET: z.string().min(32, 'AUTH_SECRET must be at least 32 characters'),
    AUTH_GITHUB_ID: z.string().optional(),
    AUTH_GITHUB_SECRET: z.string().optional(),
    NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  },

  /**
   * å®¢æˆ·ç«¯ç¯å¢ƒå˜é‡ï¼ˆNEXT_PUBLIC_ å‰ç¼€ï¼‰
   */
  client: {
    NEXT_PUBLIC_APP_URL: z.string().url().transform((v) => v.replace(/\/$/, '')), // âš¡ è‡ªåŠ¨ç§»é™¤æœ«å°¾æ–œæ ï¼Œç¡®ä¿ CORS åŒ¹é…æˆåŠŸ
  },

  /**
   * è¿è¡Œæ—¶ç¯å¢ƒå˜é‡æ˜ å°„
   */
  runtimeEnv: {
    DATABASE_URL: process.env.DATABASE_URL,
    DATABASE_MAX_CONNECTIONS: process.env.DATABASE_MAX_CONNECTIONS,
    DATABASE_IDLE_TIMEOUT: process.env.DATABASE_IDLE_TIMEOUT,
    DATABASE_CONNECT_TIMEOUT: process.env.DATABASE_CONNECT_TIMEOUT,
    AUTH_SECRET: process.env.AUTH_SECRET,
    AUTH_GITHUB_ID: process.env.AUTH_GITHUB_ID,
    AUTH_GITHUB_SECRET: process.env.AUTH_GITHUB_SECRET,
    NODE_ENV: process.env.NODE_ENV,
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL,
  },
})
```

### 5.2 å¼ºåˆ¶éªŒè¯ (`next.config.mjs`)

```javascript
import './src/env.mjs' // âš¡ æ„å»ºæ—¶è‡ªåŠ¨éªŒè¯

/** @type {import('next').NextConfig} */
const nextConfig = {
  // ä½ çš„é…ç½®
}

export default nextConfig
```

### 5.3 ä½¿ç”¨è§„èŒƒ

```typescript
// âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨
const dbUrl = process.env.DATABASE_URL

// âœ… å¿…é¡»é€šè¿‡ env è®¿é—®
import { env } from '@/env'
const dbUrl = env.DATABASE_URL // å®Œå…¨ç±»å‹å®‰å…¨
```

---

## 6. æ•°æ®åº“é…ç½®

### 6.1 Schema å®šä¹‰ (`db/schema.ts`)

> âš ï¸ ä½¿ç”¨ DrizzleAdapter æ—¶ï¼Œéœ€è¦æŒ‰ç…§ Auth.js è¦æ±‚åˆ›å»ºå®Œæ•´çš„è¡¨ç»“æ„ã€‚
> å‚è€ƒï¼šhttps://authjs.dev/reference/adapter/drizzle

```typescript
import {
  pgTable,
  text,
  timestamp,
  uuid,
  integer,
  primaryKey,
} from 'drizzle-orm/pg-core'
import { relations } from 'drizzle-orm'
import type { AdapterAccountType } from 'next-auth/adapters'

// ========== Auth.js æ‰€éœ€è¡¨ ==========

export const users = pgTable('users', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: text('name'),
  email: text('email').unique(),
  emailVerified: timestamp('emailVerified', { mode: 'date' }),
  image: text('image'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
})

export const accounts = pgTable(
  'accounts',
  {
    userId: uuid('userId')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    type: text('type').$type<AdapterAccountType>().notNull(),
    provider: text('provider').notNull(),
    providerAccountId: text('providerAccountId').notNull(),
    refresh_token: text('refresh_token'),
    access_token: text('access_token'),
    expires_at: integer('expires_at'),
    token_type: text('token_type'),
    scope: text('scope'),
    id_token: text('id_token'),
    session_state: text('session_state'),
  },
  (account) => ({
    compoundKey: primaryKey({
      columns: [account.provider, account.providerAccountId],
    }),
  })
)

// æ³¨æ„ï¼šå½“ä½¿ç”¨ JWT ç­–ç•¥ (session.strategy: 'jwt') æ—¶ï¼Œsessions è¡¨ä¸ä¼šè¢«ä½¿ç”¨ã€‚
// ä½†ä¿ç•™æ­¤è¡¨å®šä¹‰å¯ä»¥æ–¹ä¾¿æœªæ¥åˆ‡æ¢åˆ° database ç­–ç•¥ã€‚
export const sessions = pgTable('sessions', {
  sessionToken: text('sessionToken').primaryKey(),
  userId: uuid('userId')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  expires: timestamp('expires', { mode: 'date' }).notNull(),
})

export const verificationTokens = pgTable(
  'verificationTokens',
  {
    identifier: text('identifier').notNull(),
    token: text('token').notNull(),
    expires: timestamp('expires', { mode: 'date' }).notNull(),
  },
  (verificationToken) => ({
    compositePk: primaryKey({
      columns: [verificationToken.identifier, verificationToken.token],
    }),
  })
)

// ========== ä¸šåŠ¡è¡¨ ==========

export const posts = pgTable('posts', {
  id: uuid('id').defaultRandom().primaryKey(),
  title: text('title').notNull(),
  content: text('content'),
  authorId: uuid('author_id')
    .references(() => users.id, { onDelete: 'cascade' })
    .notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
})
```

> æ•°æ®åº“å±‚ç»Ÿä¸€ä½¿ç”¨ `timestamp`/`timestamp with time zone` å­˜å‚¨æ—¶é—´ï¼›API DTO å±‚ä¸€å¾‹å°†æ—¶é—´åºåˆ—åŒ–ä¸º ISO 8601 å­—ç¬¦ä¸²ï¼ˆå¦‚ `2024-01-01T00:00:00.000Z`ï¼‰ï¼Œé¿å…åœ¨ JSON é‡Œç›´æ¥æš´éœ² `Date` å¯¹è±¡æˆ–ä¾èµ–è¿è¡Œæ—¶éšå¼åºåˆ—åŒ–ã€‚

### 6.1.1 æ—¶é—´å­—æ®µ DTO çº¦å®š

```typescript
// ä»æ•°æ®åº“å®ä½“æ˜ å°„ä¸º API DTO
// âš ï¸ ç®€åŒ–ç¤ºä¾‹ï¼šå®é™…ç±»å‹éœ€ä¸æ•°æ®åº“ Schema ä¿æŒä¸€è‡´ï¼ˆname/email åœ¨ Auth.js users è¡¨ä¸­å¯ç©ºï¼‰
type UserEntity = {
  id: string
  name: string | null
  email: string | null
  createdAt: Date
}

type UserDto = {
  id: string
  name: string | null
  email: string | null
  createdAt: string
}

function toUserDto(entity: UserEntity): UserDto {
  return {
    id: entity.id,
    name: entity.name,
    email: entity.email,
    createdAt: entity.createdAt.toISOString(),
  }
}
```

> å‰ç«¯å¦‚æœéœ€è¦ `Date` ç±»å‹ï¼Œå¯åœ¨ API Client å±‚ç»Ÿä¸€åš `new Date(dto.createdAt)` çš„è½¬æ¢ï¼Œè€Œä¸æ˜¯åœ¨åç«¯è¿”å›æ··åˆç±»å‹ã€‚

```typescript
// å…³ç³»å®šä¹‰
export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}))

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}))
```

> å¦‚æœéœ€è¦ä¸º API å…¥å‚å®šä¹‰ Zod Schemaï¼Œå¯ç»“åˆ `drizzle-zod` ä» Schema è‡ªåŠ¨æ¨å¯¼ï¼Œé¿å…é‡å¤ç»´æŠ¤ä¸¤å¥—å®šä¹‰ï¼š

```typescript
import { createInsertSchema } from 'drizzle-zod'
import { users } from '@/db/schema'

export const insertUserSchema = createInsertSchema(users)
```

### 6.2 æ•°æ®åº“è¿æ¥ (`db/index.ts`)

```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import { env } from '@/env'
import * as schema from './schema'

/**
 * å…¨å±€å•ä¾‹æ¨¡å¼ï¼ˆé˜²æ­¢ HMR æ—¶é‡å¤åˆ›å»ºè¿æ¥å’Œ drizzle å®ä¾‹ï¼‰
 */
declare global {
  // eslint-disable-next-line no-var
  var __dbConnection: postgres.Sql | undefined
  // eslint-disable-next-line no-var
  var __db: ReturnType<typeof drizzle<typeof schema>> | undefined
}

const connection = globalThis.__dbConnection ?? postgres(env.DATABASE_URL, {
  max: env.DATABASE_MAX_CONNECTIONS ?? 10,
  idle_timeout: env.DATABASE_IDLE_TIMEOUT ?? 20,
  connect_timeout: env.DATABASE_CONNECT_TIMEOUT ?? 10,
})

if (env.NODE_ENV !== 'production') {
  globalThis.__dbConnection = connection
}

export const db = globalThis.__db ?? drizzle(connection, { schema })

if (env.NODE_ENV !== 'production') {
  globalThis.__db = db
}
```

> è¯´æ˜ï¼šæ•°æ®åº“è¿æ¥æ± ä¸Šé™å¿…é¡»å¯é…ç½®ï¼ˆä¾‹å¦‚ `DATABASE_MAX_CONNECTIONS`ï¼‰ï¼Œç¦æ­¢åœ¨è§„èŒƒä¸­å†™æ­»ä¸º `1`ã€‚Serverless åœºæ™¯å»ºè®®åå°ï¼Œä½†ä»åº”é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œé¿å…ç”Ÿäº§ååè¢«è¯¯ä¼¤ã€‚

### 6.3 è¿ç§»ç®¡ç† (Drizzle Kit)

#### 6.3.1 é…ç½®æ–‡ä»¶ (`drizzle.config.ts`)

> âš ï¸ æ³¨æ„ï¼š`drizzle.config.ts` åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼Œæ— æ³•ä½¿ç”¨ TypeScript è·¯å¾„åˆ«åï¼ˆå¦‚ `@/env`ï¼‰ã€‚å»ºè®®ç›´æ¥ä½¿ç”¨ `process.env` æˆ–é€šè¿‡ `dotenv` åŠ è½½ã€‚

```typescript
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!, // ç›´æ¥ä»ç¯å¢ƒå˜é‡è¯»å–
  },
  verbose: true,
  strict: true,
})
```

#### 6.3.2 å¸¸ç”¨å‘½ä»¤

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
pnpm drizzle-kit generate

# åº”ç”¨è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
pnpm drizzle-kit push

# æŸ¥çœ‹æ•°æ®åº“
pnpm drizzle-kit studio
```

### 6.4 ç”Ÿäº§è¿ç§»ç­–ç•¥ï¼ˆCI/CD ä¸ Runtimeï¼‰

- æ¨èåœ¨ CI/CD ä¸­æ‰§è¡Œè¿ç§»ï¼Œè€Œä¸æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»
- å¦‚æœåœ¨ç”Ÿäº§é•œåƒæ„å»ºé˜¶æ®µä¼š prune devDependenciesï¼Œåˆ™ä¸è¦ä¾èµ– drizzle-kit CLI åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»

**æ–¹æ¡ˆ Aï¼šCI/CD ä½¿ç”¨ drizzle-kit**

```bash
pnpm drizzle-kit migrate
```

**æ–¹æ¡ˆ Bï¼šRuntime ä½¿ç”¨ migratorï¼ˆä¸ä¾èµ– drizzle-kit CLIï¼‰**

```typescript
import postgres from 'postgres'
import { drizzle } from 'drizzle-orm/postgres-js'
import { migrate } from 'drizzle-orm/postgres-js/migrator'
import { env } from '@/env'

const migrationClient = postgres(env.DATABASE_URL, { max: 1 })
const db = drizzle(migrationClient)

await migrate(db, { migrationsFolder: './drizzle' })
await migrationClient.end()
```

> âš ï¸ è­¦å‘Šï¼šNext.js æ‰“åŒ…ï¼ˆStandalone modeï¼‰é»˜è®¤ä¸åŒ…å« `./drizzle` ç›®å½•ã€‚è‹¥ä½¿ç”¨ Runtime è¿ç§»ï¼Œéœ€åœ¨ `next.config.mjs` ä¸­é…ç½® `outputFileTracingIncludes` æˆ–åœ¨ Dockerfile ä¸­æ˜¾å¼ COPY è¿ç§»æ–‡ä»¶å¤¹ã€‚

> æç¤ºï¼šHono è·¯ç”±ä¸­çš„ `c.req.param()` ä¾ç„¶æ˜¯åŒæ­¥è·å–ï¼Œä¸å— Next.js Page `params` å¼‚æ­¥åŒ–çš„å½±å“ï¼Œä¸¤è€…æœºåˆ¶ä¸åŒã€‚

---

## 7. è®¤è¯ä¸é‰´æƒ

### 7.1 Auth.js é…ç½® (`lib/auth.ts`)

```typescript
import NextAuth from 'next-auth'
import GitHub from 'next-auth/providers/github'
import { DrizzleAdapter } from '@auth/drizzle-adapter'
import { db } from '@/db'
import { env } from '@/env'

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: DrizzleAdapter(db),
  providers: [
    // åŠ¨æ€æ·»åŠ  GitHub Providerï¼ˆä»…å½“ç¯å¢ƒå˜é‡é…ç½®æ—¶å¯ç”¨ï¼‰
    ...(env.AUTH_GITHUB_ID && env.AUTH_GITHUB_SECRET
      ? [
          GitHub({
            clientId: env.AUTH_GITHUB_ID,
            clientSecret: env.AUTH_GITHUB_SECRET,
          }),
        ]
      : []),
  ],
  session: {
    strategy: 'jwt', // ä½¿ç”¨ JWTï¼ˆé€‚é… Serverlessï¼‰ã€‚æ³¨æ„ï¼šåœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒAdapter ä»…ç”¨äºç®¡ç† User/Account è¡¨ï¼ŒSession ä¸å­˜å…¥æ•°æ®åº“ã€‚
  },
  callbacks: {
    jwt({ token, user }) {
      // Auth.js JWT æ¨¡å¼ä¸‹ï¼Œuser å¯¹è±¡ä»…åœ¨ç™»å½•æ—¶å­˜åœ¨
      // åç»­è¯·æ±‚ä¸­éœ€è¦ä» token æ¢å¤ç”¨æˆ·ä¿¡æ¯
      if (user) {
        token.id = user.id
      }
      return token
    },
    session({ session, token }) {
      if (token.id && session.user) {
        session.user.id = token.id as string
      }
      return session
    },
  },
})
```

### 7.1.1 Next-Auth ç±»å‹æ‰©å±• (`src/types/next-auth.d.ts`)

> âš ï¸ é‡è¦ï¼šé»˜è®¤çš„ `Session['user']` ä¸åŒ…å« `id` å­—æ®µï¼Œå¿…é¡»è¿›è¡Œç±»å‹æ‰©å±•ä»¥æ”¯æŒ `strategy: 'jwt'` æ¨¡å¼ä¸‹çš„ ID ä¼ é€’ã€‚

```typescript
import { DefaultSession } from 'next-auth'

declare module 'next-auth' {
  interface Session {
    user: {
      id: string
    } & DefaultSession['user']
  }
}
```

### 7.1.2 Auth.js è·¯ç”±å…¥å£ (`src/app/api/auth/[...nextauth]/route.ts`)

> âš ï¸ é‡è¦ï¼šAuth.js çš„è·¯ç”±å¿…é¡»ç‹¬ç«‹äº Hono çš„ catch-all è·¯ç”±ï¼Œä»¥ç¡®ä¿ Next.js èƒ½ä¼˜å…ˆåŒ¹é…åˆ°è®¤è¯å›è°ƒã€‚

```typescript
import { handlers } from '@/lib/auth'
export const { GET, POST } = handlers
```

### 7.2 Next.js Middleware (`middleware.ts`)

```typescript
import { auth } from '@/lib/auth'
import { NextResponse } from 'next/server'

export default auth((req) => {
  const isLoggedIn = !!req.auth
  const isAuthPage = req.nextUrl.pathname.startsWith('/login')
  const isProtectedPage = req.nextUrl.pathname.startsWith('/dashboard')

  // å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ â†’ é‡å®šå‘åˆ°é¦–é¡µ
  if (isLoggedIn && isAuthPage) {
    return NextResponse.redirect(new URL('/dashboard', req.url))
  }

  if (!isLoggedIn && isProtectedPage) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  return NextResponse.next()
})

export const config = {
  // æ’é™¤ API è·¯ç”±ã€é™æ€æ–‡ä»¶ç­‰
  // âš¡ æ³¨æ„ï¼šAPI è·¯ç”±çš„é‰´æƒå®Œå…¨ç”± Hono ä¸­é—´ä»¶æ¥ç®¡ï¼ŒNext.js Middleware ä¸ä¼šæ‹¦æˆª API è¯·æ±‚ã€‚
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

### 7.3 Hono ä¸­é—´ä»¶ (`server/middleware/auth.ts`)

```typescript
import { createMiddleware } from 'hono/factory'
import { HTTPException } from 'hono/http-exception'
import type { Env } from '@/server/context'

/**
 * æ³¨å…¥ Session åˆ° Hono Context
 * ç”± app.api.fetch(req, { user }) ä¼ å…¥
 */
export const injectSession = createMiddleware<Env>(async (c, next) => {
  // æ­¤æ—¶ c.env.user å·²ç”± Next.js Route Handler æ³¨å…¥
  c.set('user', c.env.user)
  await next()
})

/**
 * å¼ºåˆ¶ç™»å½•ä¸­é—´ä»¶
 */
export const requireAuth = createMiddleware<Env>(async (c, next) => {
  const user = c.get('user')
  if (!user) {
    throw new HTTPException(401, { message: 'Unauthorized' })
  }
  await next()
})
```

### 7.4 Hono é›†æˆå…¥å£ï¼ˆEnv ä¸Šä¸‹æ–‡æ³¨å…¥ï¼‰

> åŸåˆ™ï¼šä¸é€šè¿‡æ•æ„Ÿ Header ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œæ˜¯åˆ©ç”¨ `app.fetch` çš„ Env å‚æ•°æ³¨å…¥ä¸Šä¸‹æ–‡ã€‚
> è·¯ç”±ç»“æ„ï¼šHono è·¯ç”±æ”¾åœ¨ `src/app/api/[[...route]]/route.ts`ï¼Œå®ƒä¼šæ•è·é™¤ `api/auth/*` ä¹‹å¤–çš„æ‰€æœ‰ `/api/*` è¯·æ±‚ã€‚

```typescript
// src/app/api/[[...route]]/route.ts
import type { NextRequest } from 'next/server'
import type { User } from 'next-auth'
import app from '@/server/app'
import { auth } from '@/lib/auth'

type EnvBindings = {
  user: User | null
}

async function handler(req: NextRequest) {
  const session = await auth()

  const env: EnvBindings = {
    user: session?.user ?? null,
  }

  return app.fetch(req, env)
}

export const GET = handler
export const POST = handler
export const PUT = handler
export const PATCH = handler
export const DELETE = handler
```

> è¯´æ˜ï¼šå¦‚æœæœªæ¥å°† Hono æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡ï¼Œæ­¤æ—¶ Env ä¸­çš„ user åº”å½“æ¥æºäºè¯¥æœåŠ¡è‡ªèº«å¯¹å‡­è¯ï¼ˆå¦‚ JWTã€session tokenï¼‰çš„éªŒè¯ç»“æœï¼Œè€Œä¸æ˜¯æ¥è‡ªä¸Šæ¸¸å¯ä¼ªé€ çš„ Headerã€‚

---

## 8. åˆ†å±‚è®¾è®¡

### 8.1 Service å±‚è®¾è®¡åŸåˆ™

- **çº¯å‡½æ•°**: æ—  HTTP ä¸Šä¸‹æ–‡ï¼ˆä¸ä¾èµ– `Request`/`Response`ï¼‰
- **å¯å¤ç”¨**: åŒæ—¶ä¾› RSC å’Œ Hono è°ƒç”¨
- **é”™è¯¯æŠ›å‡º**: ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»ï¼ˆé HTTP çŠ¶æ€ç ï¼‰
- **DTO è½¬æ¢**: å»ºè®®åœ¨ `server/dtos/` ç›®å½•å®šä¹‰ DTO ç±»å‹ä¸è½¬æ¢å‡½æ•°ï¼ˆå¦‚ `toUserDto`ï¼‰ï¼Œç”± Route å±‚è°ƒç”¨ã€‚

### 8.2 è‡ªå®šä¹‰é”™è¯¯ç±» (`lib/errors.ts`)

```typescript
export class AppError extends Error {
  constructor(message: string, public readonly code: string) {
    super(message)
    this.name = this.constructor.name
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string, id: string) {
    super(`${resource} with id ${id} not found`, 'NOT_FOUND')
  }
}

export class ForbiddenError extends AppError {
  constructor(message: string) {
    super(message, 'FORBIDDEN')
  }
}

export class ValidationError extends AppError {
  constructor(message: string) {
    super(message, 'VALIDATION_ERROR')
  }
}
```

### 8.3 Service å±‚å®ç° (`server/services/user.service.ts`)

```typescript
import { db } from '@/db'
import { users } from '@/db/schema'
import { eq, gt } from 'drizzle-orm'
import { NotFoundError } from '@/lib/errors'
import { logger } from '@/lib/logger'

export async function getUserById(userId: string) {
  logger.info('Fetching user by ID', { userId })

  const user = await db.query.users.findFirst({
    where: eq(users.id, userId),
  })

  if (!user) {
    logger.warn('User not found', { userId })
    throw new NotFoundError('User', userId)
  }

  return user
}

export async function getAllUsers(options?: { limit?: number; cursor?: string }) {
  const { limit = 20, cursor } = options ?? {}

  return await db.query.users.findMany({
    where: cursor ? gt(users.id, cursor) : undefined,
    limit: limit + 1, // å¤šå–ä¸€æ¡ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    orderBy: (users, { asc }) => [asc(users.id)],
  })
}

export async function createUser(data: { email: string; name: string }) {
  const [user] = await db.insert(users).values(data).returning()
  logger.info('User created', { userId: user.id })
  return user
}

/**
 * æ‰¹é‡æ“ä½œ + äº‹åŠ¡ç¤ºä¾‹
 */
export async function createUsersInBatch(usersData: Array<{ email: string; name: string }>) {
  return await db.transaction(async (tx) => {
    const created = await tx.insert(users).values(usersData).returning()
    logger.info('Batch users created', { count: created.length })
    return created
  })
}
```

---

## 9. å®¢æˆ·ç«¯é›†æˆ

### 9.1 ç±»å‹å¯¼å‡ºï¼ˆé›¶å‰¯ä½œç”¨ï¼‰(`server/types.ts`)

```typescript
/**
 * âš¡ å…³é”®ä¿®å¤ï¼šé¿å…åœ¨å®¢æˆ·ç«¯æ‰“åŒ…æœåŠ¡ç«¯ä»£ç 
 *
 * æ­¤æ–‡ä»¶ä»…åŒ…å«ç±»å‹å¯¼å‡ºï¼Œæ— ä»»ä½•è¿è¡Œæ—¶ä»£ç æˆ–å‰¯ä½œç”¨ã€‚
 */
export type { AppType } from './route-defs'
```

### 9.2 è·¯ç”±å®šä¹‰ä¸å®ä¾‹åˆ›å»ºåˆ†ç¦»ï¼ˆç»Ÿä¸€ä½¿ç”¨ OpenAPIHonoï¼‰

#### 9.2.0 å…±äº«ä¸Šä¸‹æ–‡å®šä¹‰ (`server/context.ts`)

> âš¡ å…³é”®ä¿®å¤ï¼šæ˜¾å¼å®šä¹‰ `Bindings` (ç”± `app.fetch` æ³¨å…¥) å’Œ `Variables` (ç”± `c.set` è®¾ç½®)ï¼Œç¡®ä¿ `c.env.user` å’Œ `c.get('user')` å‡æœ‰ç±»å‹ã€‚

```typescript
import type { User } from 'next-auth'

export type Bindings = {
  user: User | null // å¯¹åº” app.fetch(req, { user }) ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°
}

export type Variables = {
  requestId: string
  user: User | null // å¯¹åº” c.set('user', user)
}

export type Env = {
  Bindings: Bindings
  Variables: Variables
}
```

#### 9.2.1 è·¯ç”±æ‹¼è£… (`server/route-defs.ts`)

```typescript
// server/route-defs.ts
import { OpenAPIHono } from '@hono/zod-openapi'
import type { Env } from './context'
import usersRoute from './routes/users'
// import postsRoute from './routes/posts' // æŒ‰éœ€å¯ç”¨

export const routes = new OpenAPIHono<Env>({ strict: false })
  .basePath('/api')
  .route('/users', usersRoute)
  // .route('/posts', postsRoute) // æŒ‰éœ€å¯ç”¨

export type AppType = typeof routes
```

#### 9.2.2 è·¯ç”±å®ç°ç¤ºä¾‹ (`server/routes/users/index.ts`)

```typescript
import { OpenAPIHono } from '@hono/zod-openapi'
import type { Env } from '@/server/context'
import { listUsersRoute } from './defs'
import { getAllUsers } from '@/server/services/user.service'
import { toUserDto } from './dtos'

const usersRoute = new OpenAPIHono<Env>()

usersRoute.openapi(listUsersRoute, async (c) => {
  const { limit, cursor } = c.req.valid('query')
  const users = await getAllUsers({ limit, cursor })

  // åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼ˆå¤šå–äº†ä¸€æ¡ï¼‰
  const hasMore = users.length > limit
  const items = hasMore ? users.slice(0, limit) : users

  return c.json({
    items: items.map(toUserDto),
    nextCursor: hasMore ? items[items.length - 1].id : null,
  }, 200)
})

export default usersRoute
```

#### 9.2.3 Feature-based è·¯ç”±ç»„ç»‡ç¤ºä¾‹

**`server/routes/users/defs.ts`**

```typescript
import { createRoute, z } from '@hono/zod-openapi'
import { UserSchema, ErrorSchema } from './dtos'

export const listUsersRoute = createRoute({
  method: 'get',
  path: '/',
  summary: 'è·å–ç”¨æˆ·åˆ—è¡¨',
  request: {
    query: z.object({
      cursor: z.string().optional(),
      limit: z.coerce.number().int().min(1).max(100).default(20),
    }),
  },
  responses: {
    200: {
      description: 'æˆåŠŸ',
      content: {
        'application/json': {
          schema: z.object({
            items: z.array(UserSchema),
            nextCursor: z.string().nullable(),
          }),
        },
      },
    },
    400: {
      description: 'å‚æ•°é”™è¯¯',
      content: { 'application/json': { schema: ErrorSchema } },
    },
  },
})
```

**`server/routes/users/dtos.ts`**

```typescript
import { z } from 'zod'

// âš ï¸ æ³¨æ„ï¼šname/email åœ¨ Auth.js çš„ users è¡¨ä¸­æ˜¯å¯ç©ºçš„ï¼ŒDTO éœ€è¦ä¸æ•°æ®åº“ Schema ä¿æŒä¸€è‡´
export const UserSchema = z.object({
  id: z.string(),
  name: z.string().nullable(),
  email: z.string().email().nullable(),
  createdAt: z.string(),
}).openapi('User')

export const ErrorSchema = z.object({
  code: z.string(),
  message: z.string(),
  details: z.any(),
}).openapi('Error')

export function toUserDto(user: { id: string; name: string | null; email: string | null; createdAt: Date }) {
  return {
    id: user.id,
    name: user.name,
    email: user.email,
    createdAt: user.createdAt.toISOString(),
  }
}
```

> çº¦æŸï¼š`route-defs.ts` åªè´Ÿè´£è·¯ç”±æ‹¼è£…ä¸ç±»å‹å¯¼å‡ºï¼Œä¸å¼•å…¥æ•°æ®åº“è¿æ¥ã€env åˆå§‹åŒ–ã€logger å®ä¾‹ç­‰å¯èƒ½å¸¦æ¥å‰¯ä½œç”¨æˆ–å¾ªç¯ä¾èµ–çš„æ¨¡å—ï¼›API å±‚ç»Ÿä¸€ä½¿ç”¨ `OpenAPIHono`ï¼Œä»¥ä¿è¯è·¯ç”±å®šä¹‰ä¸ OpenAPI æ–‡æ¡£çš„ä¸€è‡´æ€§ã€‚

#### 9.2.4 Hono å®ä¾‹åˆ›å»º (`server/app.ts`)

```typescript
// server/app.ts
import { OpenAPIHono } from '@hono/zod-openapi'
import { HTTPException } from 'hono/http-exception'
import { ZodError } from 'zod'
import { swaggerUI } from '@hono/swagger-ui'

import { corsMiddleware } from './middleware/cors'
import { csrfMiddleware } from './middleware/csrf'
import { apiRateLimiter } from './middleware/rate-limit'
import { injectSession } from './middleware/auth'
import { withRequestContext } from '@/lib/request-context'
import { errorHandler } from '@/lib/error-handler'
import type { Env } from './context'

import { routes } from './route-defs'

const app = new OpenAPIHono<Env>({ strict: false })

// âš¡ ä¸­é—´ä»¶é¡ºåºå¾ˆé‡è¦ï¼šCORS æœ€å…ˆå¤„ç†ï¼ˆå¿«é€Ÿå“åº” OPTIONS é¢„æ£€è¯·æ±‚ï¼‰
app.use('*', corsMiddleware)

// å…¨å±€ä¸­é—´ä»¶ï¼šæ³¨å…¥ requestId + AsyncLocalStorage åŒ…è£…
app.use('*', async (c, next) => {
  const requestId = c.req.header('x-request-id') ?? crypto.randomUUID()
  c.set('requestId', requestId)
  c.header('x-request-id', requestId)

  // âš¡ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ withRequestContext åŒ…è£… next()ï¼Œç¡®ä¿ Service å±‚çš„ logger èƒ½è·å– requestId
  return await withRequestContext({ requestId }, next)
})

// è‡ªå®šä¹‰è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ï¼ˆæ›¿ä»£ hono/loggerï¼Œæ”¯æŒ requestIdï¼‰
app.use('*', async (c, next) => {
  const requestId = c.get('requestId')
  const start = Date.now()

  await next()

  const duration = Date.now() - start
  console.log(
    JSON.stringify({
      requestId,
      method: c.req.method,
      path: c.req.path,
      status: c.res.status,
      duration: `${duration}ms`,
    })
  )
})

app.use('*', csrfMiddleware)
app.use('/api/*', apiRateLimiter)
app.use('*', injectSession)

app.route('/', routes)

// OpenAPI æ–‡æ¡£ä¸ Swagger UI
app.doc('/api/doc', {
  openapi: '3.0.0',
  info: { title: 'ETF Panel API', version: '1.0.0' },
})
app.get('/api/swagger', swaggerUI({ url: '/api/doc' }))

// å…¨å±€é”™è¯¯å¤„ç†
app.onError((err, c) => {
  if (err instanceof HTTPException) {
    return c.json({ code: 'HTTP_EXCEPTION', message: err.message, details: {} }, err.status)
  }

  // å¤„ç† Zod éªŒè¯é”™è¯¯ï¼ˆæ¥è‡ª OpenAPI è·¯ç”±çš„å‚æ•°æ ¡éªŒï¼‰
  // âš¡ ä½¿ç”¨ instanceof è¿›è¡Œæ›´å¯é çš„æ£€æµ‹
  if (err instanceof ZodError) {
    return c.json({
      code: 'VALIDATION_ERROR',
      message: 'Invalid request parameters',
      details: err.flatten(),
    }, 400)
  }

  // æ˜ å°„ Service å±‚é”™è¯¯åˆ° HTTP çŠ¶æ€ç 
  const { status, code, message } = errorHandler(err)
  return c.json({ code, message, details: err instanceof Error ? (err as { details?: unknown }).details : undefined }, status)
})

export default app
```

### 9.3 RPC Client å°è£… (`lib/client.ts`)

> âš ï¸ ä¸»è¦ç”¨äº Client Componentã€‚RSC åº”éµå¾ª [3.2 è§„åˆ™](#32-æ•°æ®æµè§„åˆ™) ç›´æ¥è°ƒç”¨ Service å±‚ã€‚
>
> æ³¨æ„ï¼šæ­¤ client ä¹Ÿå¯åœ¨ Server Actions æˆ– API Route ä¸­ä½¿ç”¨ï¼ˆå¦‚éœ€è°ƒç”¨å…¶ä»–å¾®æœåŠ¡ï¼‰ï¼Œæ­¤æ—¶ä¼šèµ° SSR åˆ†æ”¯ã€‚

```typescript
import { hc } from 'hono/client'
import { env } from '@/env'
import type { AppType } from '@/server/types'

/**
 * åˆ›å»º Hono RPC å®¢æˆ·ç«¯
 *
 * æµè§ˆå™¨ç¯å¢ƒï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ '' (è‡ªåŠ¨é€‚é…å½“å‰åŸŸå)
 * æœåŠ¡ç«¯ç¯å¢ƒ(SSR/Server Actions)ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å®Œæ•´ URL (é¿å… fetch æŠ¥é”™)
 *
 * âš ï¸ å®¹å™¨åŒ–éƒ¨ç½²æ³¨æ„ï¼šåœ¨ Docker/K8s ç¯å¢ƒä¸‹ï¼Œå¦‚æœå®¹å™¨æ— æ³•é€šè¿‡å…¬ç½‘åŸŸåè®¿é—®è‡ªèº«ï¼ˆNAT å›æµé—®é¢˜ï¼‰ï¼Œ
 * SSR é˜¶æ®µè¯·æ±‚ NEXT_PUBLIC_APP_URL å¯èƒ½ä¼šè¶…æ—¶ã€‚å»ºè®®ç¡®ä¿ç½‘ç»œç­–ç•¥å…è®¸æˆ–åœ¨æœåŠ¡ç«¯ç¯å¢ƒä½¿ç”¨å†…éƒ¨é€šä¿¡åœ°å€ã€‚
 */
const baseUrl = typeof window === 'undefined' ? env.NEXT_PUBLIC_APP_URL : ''

export const client = hc<AppType>(baseUrl)
```

### 9.4 React Query é›†æˆï¼ˆClient Componentï¼‰

```typescript
import { useQuery } from '@tanstack/react-query'
import { client } from '@/lib/client'
import type { InferResponseType } from 'hono/client'

type UsersResponse = InferResponseType<typeof client.api.users.$get, 200>

export function useUsersQuery() {
  return useQuery<UsersResponse>({
    queryKey: ['users'],
    queryFn: async () => {
      const res = await client.api.users.$get()
      if (!res.ok) {
        const errorBody = await res.json()
        throw Object.assign(new Error('Failed to fetch users'), { cause: errorBody })
      }
      return await res.json()
    },
  })
}
```

#### 9.4.1 ç±»å‹æ¨å¯¼ç²¾åº¦è¦ç‚¹

- æœåŠ¡ç«¯è¿”å›å€¼è¯·ä½¿ç”¨ `c.json(body, 200)` è¿™ç±»æ˜¾å¼çŠ¶æ€ç å†™æ³•ï¼Œé¿å…å®¢æˆ·ç«¯æ¨å¯¼å‡ºè¿‡å®½çš„è”åˆç±»å‹
- ä¸è¦ä½¿ç”¨ `c.notFound()` ä½œä¸ºä¸šåŠ¡ 404 è¿”å›ï¼ˆé™¤éåšäº† NotFoundResponse çš„ç±»å‹å¢å¼ºï¼‰ï¼Œå¦åˆ™å®¢æˆ·ç«¯ `res.json()` ä¼šé€€åŒ–ä¸º `unknown`

### 9.5 OpenAPI æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆï¼ˆæ¨èï¼‰

> ä½¿ç”¨ `OpenAPIHono` + `createRoute` å®šä¹‰è·¯ç”±ï¼Œå¯ä»¥åŒæ—¶è·å¾—ï¼šå…¥å‚æ ¡éªŒã€è¿”å›å€¼ Schema çº¦æŸã€OpenAPI æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆã€‚

```typescript
import { OpenAPIHono, createRoute, z } from '@hono/zod-openapi'

const app = new OpenAPIHono()

const ErrorSchema = z.object({
  code: z.string(),
  message: z.string(),
  details: z.any(),
})

// âš ï¸ ç®€åŒ–ç¤ºä¾‹ï¼šå®é™…åº”ç”¨ä¸­éœ€æ ¹æ®æ•°æ®åº“ Schema è°ƒæ•´å¯ç©ºæ€§ï¼ˆå‚è§ 9.2.3 ä¸­çš„å®Œæ•´å®šä¹‰ï¼‰
const UserSchema = z
  .object({
    id: z.string(),
    name: z.string().nullable(),
    email: z.string().email().nullable(),
  })
  .openapi('User')

const getUserRoute = createRoute({
  method: 'get',
  path: '/users/{id}',
  request: {
    params: z.object({
      id: z.string().openapi({
        param: { name: 'id', in: 'path' },
      }),
    }),
  },
  responses: {
    200: {
      description: 'OK',
      content: {
        'application/json': { schema: UserSchema },
      },
    },
    404: {
      description: 'Not Found',
      content: {
        'application/json': { schema: ErrorSchema },
      },
    },
  },
})

app.openapi(getUserRoute, async (c) => {
  const { id } = c.req.valid('param')
  const user = await getUserById(id)
  return c.json(user, 200)
})

app.doc('/doc', {
  openapi: '3.0.0',
  info: { title: 'API', version: '1.0.0' },
})
```

> çº¦æŸï¼šä¸ºäº†è®©æ–‡æ¡£èšåˆæ­£ç¡®ï¼Œè·¯ç”±æ ‘ä¸Šå»ºè®®ç»Ÿä¸€ä½¿ç”¨ `OpenAPIHono`ï¼ˆé¿å…åœ¨å­è·¯ç”±ä¸­æ··ç”¨ plain Hono å¯¼è‡´ OpenAPI ä¿¡æ¯ä¸¢å¤±ï¼‰ã€‚

---

## 10. å®‰å…¨è§„èŒƒ

### 10.1 åŸºç¡€è§„åˆ™

- ç¦æ­¢åœ¨ä»»ä½•åœ°æ–¹ç›´æ¥è¯»å– `process.env.*`ï¼Œå¿…é¡»é€šè¿‡ `env` æ¨¡å—è®¿é—®
- ç¦æ­¢åœ¨æ—¥å¿—é‡Œè¾“å‡ºæ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€tokenã€å®Œæ•´é‚®ç®±/æ‰‹æœºå·ã€ç¬¬ä¸‰æ–¹å¯†é’¥ç­‰ï¼‰
- æ‰€æœ‰è·¨ç«™è¯·æ±‚å¿…é¡»å¯ç”¨ CSRF é˜²æŠ¤ï¼Œä¸­é—´ä»¶é»˜è®¤å¼€å¯ä¸”ä¸å¾—ç»•è¿‡
- CORS å¿…é¡»æ˜¾å¼ç™½åå•ï¼Œç¦æ­¢ä½¿ç”¨ `*`
- ç¦æ­¢ä¿¡ä»»å¤–éƒ¨ä¼ å…¥çš„æ•æ„Ÿ Headerï¼ˆä¾‹å¦‚ç”¨æˆ·èº«ä»½ Headerï¼‰ï¼Œåªèƒ½åœ¨å¯ä¿¡å…¥å£ç”Ÿæˆæ³¨å…¥

### 10.2 è·¯ç”±åˆ†ç»„çº¦å®š

- å—ä¿æŠ¤é¡µé¢ç»Ÿä¸€æ”¾åœ¨ `(dashboard)` åˆ†ç»„ä¸‹
- å…¬å¼€é¡µé¢ç»Ÿä¸€æ”¾åœ¨ `(auth)` æˆ–æ–°å¢ `(public)` åˆ†ç»„ä¸‹ï¼Œé¿å…è®¤è¯é€»è¾‘è”“å»¶

### 10.3 é€Ÿç‡é™åˆ¶ (Rate Limiting)

> é˜²æ­¢æš´åŠ›ç ´è§£å’Œ DDoS æ”»å‡»ï¼Œå»ºè®®åœ¨ API å±‚æ·»åŠ é€Ÿç‡é™åˆ¶ã€‚

```typescript
// src/server/middleware/rate-limit.ts
import { rateLimiter } from 'hono-rate-limiter'

export const apiRateLimiter = rateLimiter({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿçª—å£
  limit: 100, // æ¯ä¸ª IP æœ€å¤š 100 æ¬¡è¯·æ±‚
  standardHeaders: 'draft-6',
  keyGenerator: (c) => c.req.header('x-forwarded-for') ?? c.req.header('x-real-ip') ?? 'anonymous',
})

// é’ˆå¯¹è®¤è¯æ¥å£çš„æ›´ä¸¥æ ¼é™åˆ¶
export const authRateLimiter = rateLimiter({
  windowMs: 15 * 60 * 1000,
  limit: 10, // è®¤è¯æ¥å£é™åˆ¶æ›´ä¸¥æ ¼
  keyGenerator: (c) => c.req.header('x-forwarded-for') ?? 'anonymous',
})
```

```typescript
// åœ¨ app.ts ä¸­ä½¿ç”¨
app.use('/api/*', apiRateLimiter)

// âš ï¸ æ³¨æ„ï¼šauthRateLimiter é€‚ç”¨äºè‡ªå®šä¹‰è®¤è¯æ¥å£ï¼ˆå¦‚ /api/loginï¼‰
// Auth.js çš„ /api/auth/* è·¯ç”±ç”± Next.js Route Handler å¤„ç†ï¼Œä¸ç»è¿‡ Hono ä¸­é—´ä»¶
// å¦‚éœ€é™åˆ¶ Auth.js è·¯ç”±ï¼Œéœ€åœ¨ Next.js Middleware å±‚å®ç°
// app.use('/api/login', authRateLimiter)
```

### 10.4 SQL æ³¨å…¥é˜²æŠ¤

> Drizzle ORM é»˜è®¤ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå¯æœ‰æ•ˆé˜²æ­¢ SQL æ³¨å…¥ã€‚ä½†ä»éœ€æ³¨æ„ï¼š

- **ç¦æ­¢**ä½¿ç”¨ `sql.raw()` æ‹¼æ¥ç”¨æˆ·è¾“å…¥
- **ç¦æ­¢**ç›´æ¥å°†ç”¨æˆ·è¾“å…¥æ‹¼æ¥åˆ° SQL å­—ç¬¦ä¸²ä¸­
- ä½¿ç”¨ Drizzle çš„ç±»å‹å®‰å…¨ APIï¼ˆå¦‚ `eq()`, `like()`, `inArray()`ï¼‰æ„å»ºæŸ¥è¯¢

```typescript
// âŒ å±é™©ï¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
const result = await db.execute(sql`SELECT * FROM users WHERE name = '${userInput}'`)

// âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const result = await db.query.users.findFirst({
  where: eq(users.name, userInput),
})

// âœ… å®‰å…¨ï¼šä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆDrizzle è‡ªåŠ¨è½¬ä¹‰ï¼‰
const result = await db.execute(sql`SELECT * FROM users WHERE name = ${userInput}`)
```

### 10.5 XSS é˜²æŠ¤

- React é»˜è®¤å¯¹ JSX ä¸­çš„å˜é‡è¿›è¡Œè½¬ä¹‰ï¼Œå¯é˜²æ­¢å¤§éƒ¨åˆ† XSS æ”»å‡»
- **ç¦æ­¢**ä½¿ç”¨ `dangerouslySetInnerHTML` æ¸²æŸ“ç”¨æˆ·è¾“å…¥
- å¦‚éœ€æ¸²æŸ“å¯Œæ–‡æœ¬ï¼Œä½¿ç”¨ `DOMPurify` ç­‰åº“è¿›è¡Œæ¸…æ´—
- API è¿”å›çš„ HTML å†…å®¹å¿…é¡»ç»è¿‡æ¸…æ´—

### 10.6 Content Security Policy (CSP)

> å»ºè®®åœ¨ `next.config.mjs` æˆ– Middleware ä¸­é…ç½® CSP Headerï¼š

```typescript
// middleware.ts ä¸­æ·»åŠ å®‰å…¨ Headers
const securityHeaders = {
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  // CSP æ ¹æ®å®é™…éœ€æ±‚é…ç½®
  // 'Content-Security-Policy': "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; ...",
}

// åœ¨ middleware.ts ä¸­åº”ç”¨å®‰å…¨ Headers
export default auth((req) => {
  const response = NextResponse.next()

  // æ·»åŠ å®‰å…¨ Headers
  Object.entries(securityHeaders).forEach(([key, value]) => {
    response.headers.set(key, value)
  })

  // ... å…¶ä»–è·¯ç”±å®ˆå«é€»è¾‘ï¼ˆå‚è§ 7.2 èŠ‚ï¼‰

  return response
})
```

---

## 11. é”™è¯¯å¤„ç†

### 11.1 åˆ†å±‚è§„åˆ™

- Service å±‚åªæŠ›å‡º `AppError` åŠå…¶å­ç±»ï¼Œä¸æŠ›å‡ºä»»ä½• HTTP ç›¸å…³é”™è¯¯
- API å±‚ï¼ˆHonoï¼‰è´Ÿè´£å°†ä¸šåŠ¡é”™è¯¯æ˜ å°„ä¸º HTTP çŠ¶æ€ç ä¸ç»Ÿä¸€å“åº”ç»“æ„
- æœªçŸ¥é”™è¯¯ç»Ÿä¸€æ˜ å°„ä¸º `500`ï¼Œåªè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯

### 11.2 ç»Ÿä¸€é”™è¯¯å“åº”ç»“æ„

```json
{
  "code": "NOT_FOUND",
  "message": "User with id xxx not found",
  "details": {}
}
```

### 11.3 errorHandler çº¦å®šï¼ˆç¤ºä¾‹ï¼‰

```typescript
import { AppError } from '@/lib/errors'

export function errorHandler(err: unknown): { status: number; code: string; message: string } {
  if (err instanceof AppError) {
    if (err.code === 'VALIDATION_ERROR') return { status: 400, code: err.code, message: err.message }
    if (err.code === 'FORBIDDEN') return { status: 403, code: err.code, message: err.message }
    if (err.code === 'NOT_FOUND') return { status: 404, code: err.code, message: err.message }
    return { status: 400, code: err.code, message: err.message }
  }

  return { status: 500, code: 'INTERNAL_ERROR', message: 'Internal Server Error' }
}
```

### 11.4 æ ¡éªŒæ–¹å¼é€‰æ‹©ï¼šcreateRoute (æ¨è)

> æ ¸å¿ƒåŸåˆ™ï¼šå…¨é‡ä½¿ç”¨ `OpenAPIHono` çš„ `createRoute`ã€‚å®ƒèƒ½åŒæ—¶æä¾›ç±»å‹å®‰å…¨ã€å…¥å‚æ ¡éªŒå’Œ OpenAPI æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆï¼Œæ˜¯å®ç° Hono RPC ç±»å‹åŒæ­¥çš„æœ€ä½³å®è·µã€‚
>
> å®Œæ•´ç¤ºä¾‹è¯·å‚è§ [9.2.3 Feature-based è·¯ç”±ç»„ç»‡ç¤ºä¾‹](#923-feature-based-è·¯ç”±ç»„ç»‡ç¤ºä¾‹)ã€‚

---

## 12. æ€§èƒ½ä¼˜åŒ–

- RSC è·å–æ•°æ®ä¼˜å…ˆç›´æ¥è°ƒç”¨ Service å±‚ï¼Œç¦æ­¢â€œRSC è°ƒè‡ªèº« HTTP APIâ€
- åˆ—è¡¨æ¥å£å¿…é¡»æ”¯æŒåˆ†é¡µ/æ¸¸æ ‡ï¼Œç¦æ­¢ä¸€æ¬¡æ€§è¿”å›å…¨é‡æ•°æ®
- React Query åº”è®¾ç½®åˆç†çš„ `staleTime`ï¼Œé¿å…é¡µé¢é¢‘ç¹æŠ–åŠ¨å¼è¯·æ±‚
- æŸ¥è¯¢å¿…é¡»å¯ç´¢å¼•ï¼šwhere æ¡ä»¶ä¼˜å…ˆä½¿ç”¨ç´¢å¼•åˆ—ï¼Œå¿…è¦æ—¶è¡¥å……è”åˆç´¢å¼•

---

## 13. å¼€å‘å·¥ä½œæµ

- ä¾èµ–ç®¡ç†ç»Ÿä¸€ä½¿ç”¨ pnpmï¼Œé”æ–‡ä»¶å¿…é¡»çº³å…¥ç‰ˆæœ¬æ§åˆ¶
- ä»£ç é£æ ¼ä¸é™æ€æ£€æŸ¥ç»Ÿä¸€ä½¿ç”¨ Biomeï¼Œæäº¤å‰å¿…é¡»é€šè¿‡
- æ•°æ®åº“è¿ç§»ç»Ÿä¸€ä½¿ç”¨ drizzle-kitï¼Œå˜æ›´å¿…é¡»åŒ…å«è¿ç§»æ–‡ä»¶
- å¦‚æœ CI/CD éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»ï¼Œéœ€ç¡®ä¿ `drizzle-kit` åœ¨å¯¹åº”ç¯å¢ƒå¯ç”¨ï¼Œæˆ–æ”¹ä¸ºä½¿ç”¨ `drizzle-orm/postgres-js/migrator` åœ¨ runtime æ‰§è¡Œè¿ç§»è„šæœ¬

### 13.1 å…¨é“¾è·¯æ—¥å¿—è¿½è¸ªï¼ˆRequest Contextï¼‰

> âš ï¸ è¿è¡Œæ—¶é™åˆ¶ï¼š`AsyncLocalStorage` ä»…åœ¨ Node.js Runtime å¯ç”¨ï¼Œä¸æ”¯æŒ Vercel Edge Runtimeã€‚
> å¦‚éœ€åœ¨ Edge Runtime ä½¿ç”¨ï¼Œè¯·æ”¹ç”¨ Hono Context (`c.set`/`c.get`) ä¼ é€’ requestIdã€‚

> å»ºè®®ï¼šåœ¨ `src/lib/request-context.ts` ä¸­å®šä¹‰ï¼Œå¹¶åœ¨ `app.ts` çš„ä¸­é—´ä»¶ä¸­ä½¿ç”¨ã€‚

```typescript
// src/lib/request-context.ts
import { AsyncLocalStorage } from 'node:async_hooks'

export type RequestContext = {
  requestId: string
}

const requestContextStorage = new AsyncLocalStorage<RequestContext>()

export function withRequestContext<T>(ctx: RequestContext, fn: () => T) {
  return requestContextStorage.run(ctx, fn)
}

export function getRequestId() {
  return requestContextStorage.getStore()?.requestId
}
```

```typescript
// server/app.ts (éƒ¨åˆ†)
import { withRequestContext } from '@/lib/request-context'

app.use('*', async (c, next) => {
  const requestId = c.req.header('x-request-id') ?? crypto.randomUUID()
  c.set('requestId', requestId)  // åŒæ—¶å­˜å…¥ Hono Contextï¼ˆä¾› Route å±‚ä½¿ç”¨ï¼‰
  c.header('x-request-id', requestId)

  // âš¡ å…³é”®ï¼šä½¿ç”¨ withRequestContext åŒ…è£… next()ï¼Œç¡®ä¿ Service å±‚çš„ logger èƒ½è·å– requestId
  return await withRequestContext({ requestId }, next)
})
```

> æ›¿ä»£æ–¹æ¡ˆï¼ˆEdge Runtime å…¼å®¹ï¼‰ï¼šç›´æ¥ä½¿ç”¨ Hono Context ä¼ é€’ requestIdï¼Œæ— éœ€ AsyncLocalStorageï¼š
> ```typescript
> // åœ¨ä¸­é—´ä»¶ä¸­è®¾ç½®
> c.set('requestId', requestId)
> // åœ¨ handler ä¸­è·å–
> const requestId = c.get('requestId')
> ```

---

## 14. æœ€ä½³å®è·µ

- Client Component åªé€šè¿‡ hooks è®¿é—®æœåŠ¡ç«¯æ•°æ®ï¼Œä¸ç›´æ¥æ‹¼ URL
- Service å±‚å‡½æ•°å‚æ•°å¿…é¡»æ˜¾å¼ï¼ˆDTO/Schemaï¼‰ï¼Œç¦æ­¢é€ä¼  `Request`/`Context`
- è·¯ç”±å±‚åªåšï¼šå‚æ•°æ ¡éªŒã€é‰´æƒã€è°ƒç”¨ Serviceã€è¿”å› DTO
- æ–°å¢æ¨¡å—æ—¶æŒ‰æ—¢æœ‰ç»“æ„è½ä½ï¼šschema â†’ service â†’ route â†’ client hook

---

## 15. æ ¸å¿ƒå·¥å…·å®ç°å‚è€ƒ

### 15.1 Logger å®ç° (`src/lib/logger.ts`)

```typescript
import { env } from '@/env'
import { getRequestId } from './request-context'

export const logger = {
  info: (message: string, payload?: Record<string, unknown>) => {
    console.log(JSON.stringify({
      level: 'info',
      requestId: getRequestId() ?? 'system',
      message,
      ...payload
    }))
  },
  warn: (message: string, payload?: Record<string, unknown>) => {
    console.warn(JSON.stringify({
      level: 'warn',
      requestId: getRequestId() ?? 'system',
      message,
      ...payload
    }))
  },
  error: (message: string, error?: unknown, payload?: Record<string, unknown>) => {
    const errorInfo = error instanceof Error
      ? {
          errorMessage: error.message,
          name: error.name,
          // ç”Ÿäº§ç¯å¢ƒä¸æš´éœ² stack trace
          ...(env.NODE_ENV !== 'production' && { stack: error.stack }),
        }
      : { raw: String(error) }

    console.error(JSON.stringify({
      level: 'error',
      requestId: getRequestId() ?? 'system',
      message,
      ...errorInfo,
      ...payload
    }))
  }
}

// ä½¿ç”¨ç¤ºä¾‹
logger.info('Fetching user by ID', { userId: '123' })
```

### 15.2 CORS ä¸­é—´ä»¶ (`src/server/middleware/cors.ts`)

```typescript
import { cors } from 'hono/cors'
import { env } from '@/env'

// æ„å»ºå…è®¸çš„ Origin åˆ—è¡¨
const allowedOrigins = [
  env.NEXT_PUBLIC_APP_URL,
  // å¼€å‘ç¯å¢ƒå…è®¸ localhost
  ...(env.NODE_ENV === 'development'
    ? ['http://localhost:3000', 'http://127.0.0.1:3000']
    : []),
]

export const corsMiddleware = cors({
  origin: allowedOrigins,
  credentials: true,
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization', 'x-request-id'],
  exposeHeaders: ['x-request-id'],
})
```

### 15.3 CSRF ä¸­é—´ä»¶ (`src/server/middleware/csrf.ts`)

```typescript
import { csrf } from 'hono/csrf'
import { env } from '@/env'

// æ„å»ºå…è®¸çš„ Origin åˆ—è¡¨
const allowedOrigins = [
  env.NEXT_PUBLIC_APP_URL,
  // å¼€å‘ç¯å¢ƒå…è®¸ localhost
  ...(env.NODE_ENV === 'development'
    ? ['http://localhost:3000', 'http://127.0.0.1:3000']
    : []),
]

export const csrfMiddleware = csrf({
  origin: allowedOrigins,
})
```

### 15.4 å…¨å±€ Providers (`src/app/providers.tsx`)

```typescript
'use client'

import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { useState } from 'react'

export function Providers({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 60 * 1000,
          },
        },
      })
  )

  return <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
}
```

### 15.5 æ ¹å¸ƒå±€ä½¿ç”¨ Providers (`src/app/layout.tsx`)

```typescript
import { Providers } from './providers'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

### 15.6 ç¯å¢ƒå˜é‡æ¨¡æ¿ (`.env.example`)

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL="postgresql://user:password@localhost:5432/mydb"
DATABASE_MAX_CONNECTIONS=10
DATABASE_IDLE_TIMEOUT=20
DATABASE_CONNECT_TIMEOUT=10

# Auth.js é…ç½®
AUTH_SECRET="your-secret-key-at-least-32-characters-long"
AUTH_GITHUB_ID=""
AUTH_GITHUB_SECRET=""

# åº”ç”¨ URLï¼ˆç”¨äº CORS å’Œ RPC Clientï¼‰
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

### 15.7 æ¨èçš„ package.json scripts

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "biome check .",
    "lint:fix": "biome check --apply .",
    "db:generate": "drizzle-kit generate",
    "db:push": "drizzle-kit push",
    "db:migrate": "drizzle-kit migrate",
    "db:studio": "drizzle-kit studio"
  }
}
```

### 15.8 æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼ˆå¯é€‰å¢å¼ºï¼‰

> å¦‚éœ€æ›´ç²¾ç»†çš„æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼Œå¯åœ¨ `env.mjs` ä¸­æ·»åŠ  `LOG_LEVEL` é…ç½®ï¼š

```javascript
// env.mjs æ·»åŠ 
server: {
  LOG_LEVEL: z.enum(['debug', 'info', 'warn', 'error']).default('info'),
  // ...å…¶ä»–é…ç½®
}
```

```typescript
// logger.ts å¢å¼ºç‰ˆ
import { env } from '@/env'
import { getRequestId } from './request-context'

const levels = { debug: 0, info: 1, warn: 2, error: 3 } as const
const currentLevel = levels[env.LOG_LEVEL]

const shouldLog = (level: keyof typeof levels) => levels[level] >= currentLevel

export const logger = {
  debug: (message: string, payload?: Record<string, unknown>) => {
    if (!shouldLog('debug')) return
    console.debug(JSON.stringify({
      level: 'debug',
      requestId: getRequestId() ?? 'system',
      message,
      ...payload
    }))
  },
  info: (message: string, payload?: Record<string, unknown>) => {
    if (!shouldLog('info')) return
    console.log(JSON.stringify({
      level: 'info',
      requestId: getRequestId() ?? 'system',
      message,
      ...payload
    }))
  },
  warn: (message: string, payload?: Record<string, unknown>) => {
    if (!shouldLog('warn')) return
    console.warn(JSON.stringify({
      level: 'warn',
      requestId: getRequestId() ?? 'system',
      message,
      ...payload
    }))
  },
  error: (message: string, error?: unknown, payload?: Record<string, unknown>) => {
    if (!shouldLog('error')) return
    const errorInfo = error instanceof Error
      ? {
          errorMessage: error.message,
          name: error.name,
          ...(env.NODE_ENV !== 'production' && { stack: error.stack }),
        }
      : { raw: String(error) }

    console.error(JSON.stringify({
      level: 'error',
      requestId: getRequestId() ?? 'system',
      message,
      ...errorInfo,
      ...payload
    }))
  }
}
```
